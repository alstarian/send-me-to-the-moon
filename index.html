<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MoonFund</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 400px; margin: auto; }
    button { padding: 10px 20px; margin: 5px 0; width: 100%; }
    #status { margin-top: 15px; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>MoonFund</h1>
  <button id="connect">Connect Wallet</button>
  <button id="donate">Donate 1 USDC</button>
  <button id="withdraw">Withdraw (Creator)</button>
  <button id="refund">Claim Refund</button>
  <div id="status">Status: Not connected</div>

  <!-- Load ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

  <script>
    const contractAddress = "0x9BF0898b74Dd8535cCae7dc5D2404d25a382758A";
    const abi = [ /* Your ABI JSON here, keep the same as before */ ];

    let provider, signer, contract, userAddress;

    // Hide withdraw/refund by default
    document.getElementById("withdraw").style.display = "none";
    document.getElementById("refund").style.display = "none";

    async function connectWallet() {
      try {
        if (!window.ethereum) {
          alert("MetaMask not detected!");
          return;
        }

        // Use window.ethers explicitly
        provider = new window.ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new window.ethers.Contract(contractAddress, abi, signer);

        document.getElementById("status").innerText = "Wallet connected: " + userAddress;

        // Show withdraw if creator
        const creator = await contract.creator();
        if (creator.toLowerCase() === userAddress.toLowerCase()) {
          document.getElementById("withdraw").style.display = "block";
        }

        // Show refund if user contributed and goal not unlocked
        const contribution = await contract.contributions(userAddress);
        const progressData = await contract.progress();
        const unlocked = progressData.unlocked_;
        if (contribution > 0 && !unlocked) {
          document.getElementById("refund").style.display = "block";
        }

      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Error connecting wallet: " + err.message;
      }
    }

    async function donate() {
      if (!contract) return alert("Connect wallet first");
      try {
        const tx = await contract.donate(1000000); // 1 USDC = 1e6
        await tx.wait();
        document.getElementById("status").innerText = "Donation sent!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Donation error: " + err.message;
      }
    }

    async function withdraw() {
      if (!contract) return alert("Connect wallet first");
      try {
        const tx = await contract.withdraw();
        await tx.wait();
        document.getElementById("status").innerText = "Withdrawn successfully!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Withdraw error: " + err.message;
      }
    }

    async function refund() {
      if (!contract) return alert("Connect wallet first");
      try {
        const tx = await contract.refund();
        await tx.wait();
        document.getElementById("status").innerText = "Refund claimed!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Refund error: " + err.message;
      }
    }

    document.getElementById("connect").onclick = connectWallet;
    document.getElementById("donate").onclick = donate;
    document.getElementById("withdraw").onclick = withdraw;
    document.getElementById("refund").onclick = refund;
  </script>
</body>
</html>
