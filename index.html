<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Moon Fund</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a1a;
      color: #8b5cf6;
      text-align: center;
      padding: 40px;
      margin: 0;
    }
    h1 { font-size: 48px; margin: 20px 0; }
    .card {
      background: #111120;
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      margin: 20px auto;
      border: 2px solid #8b5cf6;
    }
    input, button {
      padding: 14px;
      margin: 10px;
      font-size: 18px;
      width: 90%;
      border-radius: 10px;
    }
    input { background: white; border: 1px solid #ccc; }
    button {
      background: #8b5cf6;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #7c3aed; }
    .progress { font-size: 24px; margin: 20px; font-weight: bold; }
    .countdown { font-size: 18px; margin: 10px; color: #a78bfa; }
    .refund { display: none; background: #e91e63 !important; }
    small { color: #aaa; }
    a { color: #8b5cf6; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>MOON FUND</h1>
  <div class="card">
    <div class="progress" id="progress">Loading ethers.js...</div>
    <div class="countdown" id="countdown"></div>
    <input type="number" id="amount" placeholder="USDC Amount (min 1)" min="1" step="0.01" />
    <button id="connect" style="display:none">Connect Wallet</button>
    <button id="donate" style="display:none">Donate & Get NFT</button>
    <button id="refund" class="refund">Refund My Donation</button>
    <p><small>Contract: <a href="https://basescan.org/address/0xb08Ce7ab25e1cB1F0e3F8A3216914ddF00f049a4" target="_blank">0xb08C...49a4</a></small></p>
  </div>

  <!-- RELIABLE CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
    async function waitForEthers() {
      if (typeof ethers === "undefined") {
        setTimeout(waitForEthers, 200);
        return;
      }
      initApp();
    }

    function initApp() {
      const progressEl = document.getElementById("progress");
      const connectBtn = document.getElementById("connect");
      const donateBtn = document.getElementById("donate");
      const refundBtn = document.getElementById("refund");
      const countdownEl = document.getElementById("countdown");

      const CONTRACT = "0xb08Ce7ab25e1cB1F0e3F8A3216914ddF00f049a4";
      const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
      const DEADLINE = 1767225600; // Unix timestamp

      const ABI = [
        "function donate(uint256 amount)",
        "function refund()",
        "function progress() view returns (uint256 raised, uint256 goal, bool unlocked, uint256 timeLeft, uint256 timeUntilWithdraw, bool paused)",
        "function contributions(address) view returns (uint256)"
      ];

      let provider, signer, contract, account;

      async function updateProgress() {
        if (!contract) return;
        try {
          const p = await contract.progress();
          const raised = ethers.utils.formatUnits(p.raised, 6);
          const goal = ethers.utils.formatUnits(p.goal, 6);
          progressEl.innerHTML = `Raised: $${raised} / $${goal}`;

          const now = Math.floor(Date.now() / 1000);
          if (now < DEADLINE) {
            const timeLeft = DEADLINE - now;
            const days = Math.floor(timeLeft / 86400);
            const hours = Math.floor((timeLeft % 86400) / 3600);
            countdownEl.innerHTML = `Time left: ${days}d ${hours}h`;
          } else {
            countdownEl.innerHTML = `Deadline passed`;
            if (parseFloat(raised) < parseFloat(goal)) {
              refundBtn.style.display = "block";
            }
          }
        } catch (err) {
          console.error(err);
          progressEl.innerHTML = "Error loading progress...";
        }
      }

      connectBtn.style.display = "block";
      progressEl.innerHTML = "Ready. Click Connect.";

      connectBtn.onclick = async () => {
        if (!window.ethereum) {
          alert("Please install MetaMask!");
          return;
        }

        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          account = await signer.getAddress();
          contract = new ethers.Contract(CONTRACT, ABI, signer);

          connectBtn.style.display = "none";
          donateBtn.style.display = "block";
          progressEl.innerHTML = "Loading data...";

          updateProgress();
          setInterval(updateProgress, 15000);
        } catch (err) {
          console.error(err);
          alert("Connection failed: " + err.message);
        }
      };

      donateBtn.onclick = async () => {
        const amount = document.getElementById("amount").value;
        if (!amount || amount < 1) {
          alert("Minimum donation is 1 USDC");
          return;
        }

        try {
          const usdcContract = new ethers.Contract(
            USDC,
            ["function approve(address,uint256)"],
            signer
          );
          const approveTx = await usdcContract.approve(CONTRACT, ethers.utils.parseUnits(amount, 6));
          await approveTx.wait();

          const donateTx = await contract.donate(ethers.utils.parseUnits(amount, 6));
          await donateTx.wait();

          alert("Donation successful! NFT minted.");
          updateProgress();
        } catch (err) {
          console.error(err);
          alert("Transaction failed: " + err.message);
        }
      };

      refundBtn.onclick = async () => {
        try {
          const tx = await contract.refund();
          await tx.wait();
          alert("Refund successful!");
          updateProgress();
        } catch (err) {
          console.error(err);
          alert("Refund failed: " + err.message);
        }
      };
    }

    waitForEthers();
  </script>
</body>
</html>
