<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MoonFund</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 400px; margin: auto; }
    button { padding: 10px 20px; margin: 5px 0; width: 100%; }
    #status { margin-top: 15px; white-space: pre-line; }
  </style>
</head>
<body>
  <body>
  <h1>Send Me to the Moon</h1>
  <button id="connect">Connect Wallet</button>
  <button id="donate">Donate 1 USDC</button>
  <button id="withdraw">Withdraw (Creator)</button>
  <button id="refund">Claim Refund</button>
  <div id="status">Status: Not connected</div>
  <div class="progress"><div class="fill" id="fill" style="width: 0%"></div></div>
  <p>Raised: <span id="raised">$0.00</span> / <span id="goal">$2</span> â€¢ <span id="days">7</span> days left</p>

  <!-- LOAD ETHERS FIRST -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- YOUR SCRIPT AFTER -->
  <script>
    const contractAddress = "0x07a8a768CDbf15908dcCc19046427F89e605AED9";
    const usdcAddress = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const creatorAddress = "0x095c853C222934395a07D363967bed337F02a11F";

    const abi = [
      "function progress() view returns (uint256, uint256, bool, uint256, uint256)",
      "function donate(uint256)",
      "function withdraw()",
      "function refund()",
      "function contributions(address) view returns (uint256)",
      "function creator() view returns (address)",
      "function goal() view returns (uint256)",
      "function deadline() view returns (uint256)"
    ];

    let provider, signer, contract, userAddress;

    document.getElementById("withdraw").style.display = "none";
    document.getElementById("refund").style.display = "none";

    async function connectWallet() {
      try {
        if (!window.ethereum) throw new Error("MetaMask not found!");
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, abi, signer);

        document.getElementById("status").innerText = `Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;

        const creator = await contract.creator();
        if (creator.toLowerCase() === userAddress.toLowerCase()) {
          document.getElementById("withdraw").style.display = "block";
        }

        await updateProgress();
        setInterval(updateProgress, 10000);

      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err.message;
      }
    }

    async function donate() {
      if (!contract) return alert("Connect wallet first");
      try {
        const usdc = new ethers.Contract(usdcAddress, ["function approve(address,uint256) returns (bool)"], signer);
        const tx1 = await usdc.approve(contractAddress, ethers.utils.parseUnits("1", 6));
        document.getElementById("status").innerText = "Approving...";
        await tx1.wait();

        const tx2 = await contract.donate(ethers.utils.parseUnits("1", 6));
        document.getElementById("status").innerText = "Donating...";
        await tx2.wait();

        document.getElementById("status").innerText = "Donated 1 USDC!";
        await updateProgress();
      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err.message;
      }
    }

    async function withdraw() {
      if (!contract) return alert("Connect wallet first");
      try {
        const tx = await contract.withdraw();
        document.getElementById("status").innerText = "Withdrawing...";
        await tx.wait();
        document.getElementById("status").innerText = "Withdrawn!";
        await updateProgress();
      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err.message;
      }
    }

    async function refund() {
      if (!contract) return alert("Connect wallet first");
      try {
        const tx = await contract.refund();
        document.getElementById("status").innerText = "Refunding...";
        await tx.wait();
        document.getElementById("status").innerText = "Refund claimed!";
        await updateProgress();
      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err.message;
      }
    }

    async function updateProgress() {
      try {
        const [raised, goal, unlocked, timeLeft] = await contract.progress();
        const raisedUSD = Number(ethers.utils.formatUnits(raised, 6)).toFixed(2);
        const goalUSD = Number(ethers.utils.formatUnits(goal, 6)).toFixed(0);
        const daysLeft = Math.ceil(timeLeft / 86400);

        document.getElementById("raised").innerText = `$${raisedUSD}`;
        document.getElementById("goal").innerText = `$${goalUSD}`;
        document.getElementById("days").innerText = daysLeft;
        document.getElementById("fill").style.width = `${(raised * 100n) / goal}%`;

        const contrib = await contract.contributions(userAddress || "0x0");
        if (contrib > 0 && daysLeft === 0 && !unlocked) {
          document.getElementById("refund").style.display = "block";
        }
      } catch (err) {
        console.error(err);
      }
    }

    document.getElementById("connect").onclick = connectWallet;
    document.getElementById("donate").onclick = donate;
    document.getElementById("withdraw").onclick = withdraw;
    document.getElementById("refund").onclick = refund;
  </script>
</body>
</body>
</html>
