<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Moon Fund</title>
  <style>
    body { font-family: 'Courier New', monospace; background: #0a0a1a; color: #8b5cf6; text-align: center; padding: 40px; margin: 0; }
    h1 { font-size: 48px; margin: 20px 0; }
    .card { background: #111120; padding: 30px; border-radius: 20px; max-width: 500px; margin: 20px auto; border: 2px solid #8b5cf6; }
    input, button { padding: 14px; margin: 10px; font-size: 18px; width: 90%; border-radius: 10px; }
    input { background: white; border: 1px solid #ccc; }
    button { background: #8b5cf6; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: #7c3aed; }
    .progress { font-size: 24px; margin: 20px; font-weight: bold; }
    .countdown { font-size: 18px; margin: 10px; color: #a78bfa; }
    .refund { display: none; background: #e91e63 !important; }
    small { color: #aaa; }
    a { color: #8b5cf6; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>MOON FUND</h1>
  <div class="card">
    <div class="progress" id="progress">Loading ethers.js...</div>
    <div class="countdown" id="countdown"></div>
    <input type="number" id="amount" placeholder="USDC Amount (min 1)" min="1" step="0.01" />
    <button id="connect" style="display:none">Connect Wallet</button>
    <button id="donate" style="display:none">Donate & Get NFT</button>
    <button id="refund" class="refund">Refund My Donation</button>
    <p><small>Contract: <a href="https://basescan.org/address/0xb08Ce7ab25e1cB1F0e3F8A3216914ddF00f049a4" target="_blank">0xb08C...49a4</a></small></p>
  </div>

  <!-- RELIABLE CDN + FALLBACK -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
    // Wait for ethers to load
    function waitForEthers() {
      if (typeof ethers !== 'undefined') {
        initApp();
      } else {
        setTimeout(waitForEthers, 100);
      }
    }

    function initApp() {
      document.getElementById("progress").innerHTML = "Ready. Click Connect.";
      document.getElementById("connect").style.display = "block";

      const CONTRACT = "0xb08Ce7ab25e1cB1F0e3F8A3216914ddF00f049a4";
      const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
      const DEADLINE = 1767225600; // Unix timestamp

      const ABI = [
        "function donate(uint256 amount)",
        "function refund()",
        "function progress() view returns (uint256 raised, uint256 goal, bool unlocked, uint256 timeLeft, uint256 timeUntilWithdraw, bool paused)",
        "function contributions(address) view returns (uint256)"
      ];

      let provider, signer, contract, account;

      async function updateProgress() {
        if (!contract) return;
        try {
          const p = await contract.progress();
          const raised = ethers.utils.formatUnits(p.raised, 6);
          const goal = ethers.utils.formatUnits(p.goal, 6);
          document.getElementById("progress").innerHTML = `Raised: $${raised} / $${goal}`;

          const now = Math.floor(Date.now() / 1000);
          if (now < DEADLINE) {
            const days = Math.floor((DEADLINE - now) / 86400);
            document.getElementById("countdown").innerHTML = `Time left: ${days} days`;
          } else {
            document.getElementById("countdown").innerHTML = `Deadline passed`;
            if (raised < goal) {
              document.getElementById("refund").style.display = "block";
            }
          }
        } catch (e) {
          console.error(e);
          document.getElementById("progress").innerHTML = "Error loading progress...";
        }
      }

      document.getElementById("connect").onclick = async () => {
        if (!window.ethereum) return alert("Install MetaMask!");
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          account = await signer.getAddress();
          contract = new ethers.Contract(CONTRACT, ABI, signer);

          document.getElementById("connect").style.display = "none";
          document.getElementById("donate").style.display = "block";
          document.getElementById("progress").innerHTML = "Loading...";

          updateProgress();
          setInterval(updateProgress, 10000);
        } catch (e) {
          alert("Connection failed: " + e.message);
        }
      };

      document.getElementById("donate").onclick = async () => {
        const amount = document.getElementById("amount").value;
        if (!amount || amount < 1) return alert("Min 1 USDC");
        try {
          const usdcContract = new ethers.Contract(USDC, ["function approve(address,uint256)"], signer);
          const approveTx = await usdcContract.approve(CONTRACT, ethers.utils.parseUnits(amount, 6));
          await approveTx.wait();

          const donateTx = await contract.donate(ethers.utils.parseUnits(amount, 6));
          await donateTx.wait();

          alert("Donated! NFT minted.");
          updateProgress();
        } catch (e) {
          alert("Transaction failed: " + e.message);
        }
      };

      document.getElementById("refund").onclick = async () => {
        try {
          const tx = await contract.refund();
          await tx.wait();
          alert("Refunded!");
          updateProgress();
        } catch (e) {
          alert("Refund failed: " + e.message);
        }
      };
    }

    // Start checking
    waitForEthers();
  </script>
</body>
</html>
