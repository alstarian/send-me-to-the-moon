<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker</title>

<!-- iOS App Icons -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.jpg">
<link rel="apple-touch-icon" sizes="152x152" href="icon.jpg">
<link rel="apple-touch-icon" sizes="120x120" href="icon.jpg">
<link rel="icon" type="image/jpeg" href="icon.jpg">

<!-- PWA Settings -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Expense Tracker">

<!-- Theme Colors -->
<meta name="theme-color" content="#000000">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="icon.jpg">

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}.app-header{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,rgba(10,10,10,.95) 0%,rgba(0,0,0,.98) 100%);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid rgba(255,255,255,.1);padding:16px 20px;display:flex;align-items:center;justify-content:center;gap:16px;z-index:1001;box-shadow:0 4px 24px rgba(0,0,0,.5)}.app-logo{font-size:2.5rem;animation:float 3s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(251,191,36,.4))}.app-title{font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#fbbf24,#f59e0b,#fbbf24);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-1px;animation:gradient-shift 3s ease infinite}@keyframes gradient-shift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#000;background-image:radial-gradient(at 0% 0%,rgba(30,64,175,.15) 0px,transparent 50%),radial-gradient(at 100% 0%,rgba(139,92,246,.15) 0px,transparent 50%),radial-gradient(at 100% 100%,rgba(16,185,129,.1) 0px,transparent 50%);min-height:100vh;padding:100px 20px 60px 20px;display:flex;align-items:center;justify-content:center;color:#fff;position:relative;overflow-x:hidden}body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 48%,rgba(255,255,255,.01) 50%,transparent 52%),linear-gradient(-45deg,transparent 48%,rgba(255,255,255,.01) 50%,transparent 52%);background-size:60px 60px;pointer-events:none;opacity:.3}.container{max-width:1600px;width:100%;display:grid;grid-template-columns:1fr 1fr;gap:32px;position:relative;z-index:1}.sync-bar{grid-column:1/-1;background:rgba(255,255,255,.03);backdrop-filter:blur(30px) saturate(180%);-webkit-backdrop-filter:blur(30px) saturate(180%);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:20px 28px;display:flex;gap:16px;justify-content:center;align-items:center;flex-wrap:wrap;box-shadow:0 8px 32px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.1);position:relative;overflow:hidden}.sync-bar::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.05),transparent);animation:shimmer 3s infinite}@keyframes shimmer{to{left:200%}}.sync-btn{background:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.05));border:1px solid rgba(255,255,255,.15);color:white;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:.95rem;font-weight:600;transition:all .3s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;gap:10px;position:relative;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.2)}.sync-btn::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(255,255,255,.2),transparent);opacity:0;transition:opacity .3s}.sync-btn:hover::before{opacity:1}.sync-btn:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.3)}.sync-btn:active{transform:translateY(-1px)}.sync-btn.export{background:linear-gradient(135deg,rgba(16,185,129,.25),rgba(16,185,129,.15));border-color:rgba(16,185,129,.4);box-shadow:0 4px 20px rgba(16,185,129,.2)}.sync-btn.import{background:linear-gradient(135deg,rgba(99,102,241,.25),rgba(99,102,241,.15));border-color:rgba(99,102,241,.4);box-shadow:0 4px 20px rgba(99,102,241,.2)}.sync-btn.analytics{background:linear-gradient(135deg,rgba(251,191,36,.25),rgba(251,191,36,.15));border-color:rgba(251,191,36,.4);box-shadow:0 4px 20px rgba(251,191,36,.2)}.sync-btn.insights{background:linear-gradient(135deg,rgba(236,72,153,.25),rgba(236,72,153,.15));border-color:rgba(236,72,153,.4);box-shadow:0 4px 20px rgba(236,72,153,.2)}.sync-btn.settings{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(139,92,246,.15));border-color:rgba(139,92,246,.4);box-shadow:0 4px 20px rgba(139,92,246,.2)}.sync-btn.danger{background:linear-gradient(135deg,rgba(239,68,68,.25),rgba(239,68,68,.15));border-color:rgba(239,68,68,.4);box-shadow:0 4px 20px rgba(239,68,68,.2)}.pane{background:linear-gradient(135deg,rgba(30,30,30,.95) 0%,rgba(15,15,15,.98) 100%);backdrop-filter:blur(30px) saturate(180%);-webkit-backdrop-filter:blur(30px) saturate(180%);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:36px;box-shadow:0 24px 64px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.1);position:relative;overflow:hidden;transition:all .4s cubic-bezier(.4,0,.2,1)}.pane::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent)}.pane::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 50% 0%,rgba(255,255,255,.05),transparent 70%);pointer-events:none}.pane.current{border-color:rgba(251,191,36,.4);box-shadow:0 24px 64px rgba(0,0,0,.5),0 0 40px rgba(251,191,36,.15),inset 0 1px 0 rgba(251,191,36,.2)}.pane.current::before{background:linear-gradient(90deg,transparent,rgba(251,191,36,.4),transparent)}.pane.monthly{border-color:rgba(59,130,246,.4);box-shadow:0 24px 64px rgba(0,0,0,.5),0 0 40px rgba(59,130,246,.15),inset 0 1px 0 rgba(59,130,246,.2)}.pane.monthly::before{background:linear-gradient(90deg,transparent,rgba(59,130,246,.4),transparent)}.pane:hover{transform:translateY(-4px);box-shadow:0 32px 80px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.15)}.pane-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,.08);position:relative;z-index:1;gap:20px}.period-nav{display:flex;gap:12px;align-items:center;flex:1}.period-nav button{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:white;width:36px;height:36px;border-radius:8px;cursor:pointer;font-size:1.1rem;transition:all .2s;display:flex;align-items:center;justify-content:center}.period-nav button:hover{background:rgba(255,255,255,.15);transform:scale(1.1)}.period-nav button:active{transform:scale(.95)}.period-title{font-size:1.1rem;font-weight:600;color:#fff;text-align:center;flex:1}.star-toggle{font-size:1.8rem;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);user-select:none;filter:grayscale(100%) brightness(.5);flex-shrink:0}.star-toggle:hover{transform:scale(1.2) rotate(15deg);filter:grayscale(0%) brightness(1)}.star-toggle.active{filter:grayscale(0%) brightness(1);animation:pulse 2s ease-in-out infinite;text-shadow:0 0 12px rgba(251,191,36,.6)}@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.15)}}.summary{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:28px;position:relative;z-index:1}.summary-item{background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.03));padding:18px;border-radius:14px;text-align:center;border:1px solid rgba(255,255,255,.1);transition:all .3s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.1)}.summary-item.full-width{grid-column:1/-1}.summary-item::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(255,255,255,.1),transparent);opacity:0;transition:opacity .3s}.summary-item:hover::before{opacity:1}.summary-item:hover{border-color:rgba(255,255,255,.2);transform:translateY(-3px) scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.15)}.summary-label{font-size:.65rem;color:rgba(255,255,255,.6);margin-bottom:8px;text-transform:uppercase;letter-spacing:1.2px;font-weight:600}.summary-value{font-size:1.6rem;font-weight:800;color:#fff;letter-spacing:-1px;text-shadow:0 2px 12px rgba(0,0,0,.3)}.summary-value.positive{color:#10b981;text-shadow:0 2px 12px rgba(16,185,129,.4)}.summary-value.negative{color:#ef4444;text-shadow:0 2px 12px rgba(239,68,68,.4)}.summary-value.info{color:#8b5cf6;text-shadow:0 2px 12px rgba(139,92,246,.4)}.input-group{margin-bottom:16px;position:relative;z-index:1}.input-label{font-size:.75rem;color:rgba(255,255,255,.7);margin-bottom:8px;display:block;font-weight:600;text-transform:uppercase;letter-spacing:.8px}input,select{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:#fff;font-size:.95rem;font-family:inherit;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:inset 0 2px 8px rgba(0,0,0,.15)}input[type="date"]{color-scheme:dark}input::placeholder{color:rgba(255,255,255,.35)}input:focus,select:focus{outline:0;background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.25);box-shadow:inset 0 2px 8px rgba(0,0,0,.15),0 0 0 4px rgba(255,255,255,.05);transform:translateY(-1px)}select option{background:#1a1a1a;color:#fff}.btn{width:100%;background:linear-gradient(135deg,#fff,#f0f0f0);color:#0a0a0a;border:none;border-radius:10px;padding:14px;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);text-transform:uppercase;letter-spacing:.8px;position:relative;overflow:hidden;box-shadow:0 4px 16px rgba(255,255,255,.15),0 8px 24px rgba(0,0,0,.2)}.btn::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(255,255,255,.3),transparent);opacity:0;transition:opacity .3s}.btn:hover::before{opacity:1}.btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(255,255,255,.2),0 12px 32px rgba(0,0,0,.3)}.btn:active{transform:translateY(-1px)}.quick-add-section{margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,.08);position:relative;z-index:1}.quick-add-label{font-size:.75rem;color:rgba(255,255,255,.6);margin-bottom:10px;text-transform:uppercase;letter-spacing:.8px;font-weight:600}.quick-add-buttons{display:flex;flex-wrap:wrap;gap:8px}.quick-add-btn{background:linear-gradient(135deg,rgba(251,191,36,.15),rgba(251,191,36,.08));border:1px solid rgba(251,191,36,.3);color:#fbbf24;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .3s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;gap:6px;white-space:nowrap;box-shadow:0 2px 8px rgba(251,191,36,.1)}.quick-add-btn:hover{background:linear-gradient(135deg,rgba(251,191,36,.25),rgba(251,191,36,.15));border-color:rgba(251,191,36,.5);transform:translateY(-2px);box-shadow:0 4px 12px rgba(251,191,36,.2)}.quick-add-btn:active{transform:translateY(0)}.quick-add-empty{font-size:.85rem;color:rgba(255,255,255,.4);font-style:italic}.expenses-list{max-height:350px;overflow-y:auto;overflow-x:hidden;margin-top:20px;padding-right:8px;position:relative;z-index:1}.expense-item-wrapper{position:relative;margin-bottom:10px;overflow:visible}.expense-item{background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.03));padding:14px 16px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.08);box-shadow:0 2px 8px rgba(0,0,0,.15);position:relative;touch-action:pan-y;-webkit-user-select:none;user-select:none;will-change:transform;-webkit-transform:translate3d(0,0,0);transform:translate3d(0,0,0)}.expense-item.transitioning{transition:transform .3s cubic-bezier(.4,0,.2,1)}.swipe-actions{position:absolute;right:0;top:0;bottom:0;display:flex;opacity:0;transition:opacity .3s;pointer-events:none}.expense-item.swiped{transform:translate3d(-160px,0,0)}.expense-item.swiped+.swipe-actions{opacity:1;pointer-events:auto}@media (hover:hover) and (pointer:fine){.expense-item-wrapper:hover .expense-item{transform:translate3d(-160px,0,0);transition:transform .3s cubic-bezier(.4,0,.2,1)}.expense-item-wrapper:hover .swipe-actions{opacity:1;pointer-events:auto}}.action-btn{width:80px;border:none;color:white;font-weight:700;font-size:.8rem;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;transition:all .2s}.action-btn.edit{background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:0}.action-btn.edit:hover{background:linear-gradient(135deg,#2563eb,#1d4ed8);transform:scale(1.05)}.action-btn.delete{background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:0 12px 12px 0}.action-btn.delete:hover{background:linear-gradient(135deg,#dc2626,#b91c1c);transform:scale(1.05)}.action-icon{font-size:1.2rem}.expense-info{flex:1;pointer-events:none}.expense-desc{font-size:.95rem;font-weight:600;color:#fff;margin-bottom:4px}.expense-cat{font-size:.75rem;color:rgba(255,255,255,.5)}.expense-amount{font-size:1.1rem;font-weight:700;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.2);min-width:80px;text-align:right;pointer-events:none}.empty-state{text-align:center;padding:50px 20px;color:rgba(255,255,255,.35)}.empty-state-icon{font-size:3rem;margin-bottom:16px;opacity:.5;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}.expenses-list::-webkit-scrollbar{width:6px}.expenses-list::-webkit-scrollbar-track{background:rgba(255,255,255,.03);border-radius:3px}.expenses-list::-webkit-scrollbar-thumb{background:linear-gradient(180deg,rgba(255,255,255,.15),rgba(255,255,255,.1));border-radius:3px;border:1px solid rgba(255,255,255,.05)}.expenses-list::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,rgba(255,255,255,.2),rgba(255,255,255,.15))}.month-nav{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:16px}.month-nav button{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:1.2rem;transition:all .2s}.month-nav button:hover{background:rgba(255,255,255,.15);transform:scale(1.1)}.month-display{font-size:1.1rem;font-weight:600;min-width:140px;text-align:center}.pane-title{font-size:1.4rem;font-weight:700;color:#fff;letter-spacing:-.8px;text-shadow:0 2px 10px rgba(0,0,0,.3)}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.85);backdrop-filter:blur(10px)}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:linear-gradient(135deg,rgba(30,30,30,.98) 0%,rgba(15,15,15,.98) 100%);border:1px solid rgba(255,255,255,.2);border-radius:24px;padding:40px;max-width:500px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 32px 96px rgba(0,0,0,.7);position:relative}.insights-content{max-width:700px}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,.1)}.modal-title{font-size:1.8rem;font-weight:700;color:#fff}.close-btn{background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.3);color:#ef4444;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:all .3s}.close-btn:hover{background:rgba(239,68,68,.3);transform:rotate(90deg)}.modal-buttons{display:flex;gap:12px;margin-top:24px}.modal-btn{flex:1;padding:14px;border-radius:10px;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.8px;border:none}.modal-btn.cancel{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:white}.modal-btn.cancel:hover{background:rgba(255,255,255,.15)}.modal-btn.save{background:linear-gradient(135deg,#10b981,#059669);border:none;color:white}.modal-btn.save:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(16,185,129,.4)}.insights-body{display:flex;flex-direction:column;gap:24px}.insight-section{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px}.insight-title{font-size:1.1rem;font-weight:700;color:#fff;margin-bottom:16px;display:flex;align-items:center;gap:10px}.insight-card{background:rgba(255,255,255,.05);border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}.insight-label{font-size:.9rem;color:rgba(255,255,255,.7)}.insight-value{font-size:1.3rem;font-weight:700;color:#fff}.insight-trend{font-size:.85rem;font-weight:600;margin-left:8px}.insight-trend.up{color:#ef4444}.insight-trend.down{color:#10b981}.category-breakdown{display:flex;flex-direction:column;gap:12px}.category-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,.03);border-radius:10px}.category-name{font-size:.95rem;font-weight:600;color:#fff}.category-amount{font-size:1.1rem;font-weight:700;color:#fbbf24}.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.stat-card{background:rgba(255,255,255,.05);border-radius:12px;padding:16px;text-align:center}.stat-label{font-size:.75rem;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}.stat-value{font-size:1.4rem;font-weight:800;color:#fff}.analytics-table{width:100%;border-collapse:collapse;margin-top:20px}.analytics-table th,.analytics-table td{padding:16px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08)}.analytics-table th{background:rgba(255,255,255,.05);font-weight:700;text-transform:uppercase;font-size:.75rem;letter-spacing:1px;color:rgba(255,255,255,.7)}.analytics-table td{font-size:.95rem;color:rgba(255,255,255,.9)}.analytics-table tr:hover{background:rgba(255,255,255,.03)}.analytics-table td:last-child{font-weight:700;color:#10b981}.setup-wizard{text-align:center}.setup-wizard .modal-content{max-width:600px}.wizard-icon{font-size:4rem;margin-bottom:20px;animation:float 3s ease-in-out infinite}.wizard-subtitle{font-size:1rem;color:rgba(255,255,255,.7);margin-bottom:30px;line-height:1.6}.quick-dates{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:20px 0}.quick-date-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:white;padding:12px;border-radius:10px;cursor:pointer;font-size:.9rem;font-weight:600;transition:all .3s}.quick-date-btn:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.25);transform:translateY(-2px)}.quick-date-btn.selected{background:linear-gradient(135deg,rgba(16,185,129,.25),rgba(16,185,129,.15));border-color:rgba(16,185,129,.4)}.divider{display:flex;align-items:center;gap:16px;margin:24px 0;color:rgba(255,255,255,.4);font-size:.85rem}.divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.1)}.settings-info{background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.3);border-radius:12px;padding:16px;margin-bottom:24px}.settings-info-title{font-size:.85rem;font-weight:700;color:rgba(255,255,255,.9);margin-bottom:8px;text-transform:uppercase;letter-spacing:.8px}.settings-info-value{font-size:1.1rem;font-weight:600;color:#8b5cf6}.warning-box{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:12px;padding:16px;margin:20px 0}.warning-box p{font-size:.9rem;color:rgba(255,255,255,.8);line-height:1.6;margin:0}@media (max-width:1200px){.container{grid-template-columns:1fr}}@media (max-width:768px){.app-header{padding:12px 16px}.app-logo{font-size:2rem}.app-title{font-size:1.4rem}body{padding:80px 20px 60px 20px}.summary{grid-template-columns:1fr}.stat-grid{grid-template-columns:1fr}.quick-dates{grid-template-columns:1fr}.quick-add-buttons{gap:6px}.quick-add-btn{font-size:.8rem;padding:6px 12px}.analytics-table{font-size:.85rem}.analytics-table th,.analytics-table td{padding:12px 8px}}


/* ==================== AUTHENTICATION & SWIPE STYLES ==================== */

.auth-modal .modal-content { max-width: 500px; }
.auth-content { text-align: center; }
.auth-icon { font-size: 5rem; margin: 20px 0; animation: float 3s ease-in-out infinite; }
.auth-subtitle { color: rgba(255,255,255,0.7); font-size: 0.95rem; line-height: 1.6; margin-bottom: 30px; }

.passcode-input-group { display: flex; gap: 10px; justify-content: center; margin: 30px 0; }
.passcode-digit {
      width: 50px;
      height: 60px;
      font-size: 28px;
      text-align: center;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: white;
      font-weight: 700;
      transition: all 0.2s;
      caret-color: #60a5fa;
      line-height: 60px;
      padding: 0;
      box-sizing: border-box;
    }
.passcode-digit:focus {
  border-color: #fbbf24 !important; background: rgba(251,191,36,0.1) !important;
  transform: scale(1.1); box-shadow: 0 0 20px rgba(251,191,36,0.3);
}
.passcode-hint { color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: -20px; margin-bottom: 20px; }

#lock-screen {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
  display: flex; align-items: center; justify-content: center; z-index: 10000;
}
.lock-container {
  text-align: center; padding: 40px; background: rgba(0,0,0,0.5);
  border-radius: 24px; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
}
.lock-header { margin-bottom: 20px; }
.unlock-forgot-btn {
  background: none; border: none; color: #fbbf24; font-size: 0.9rem;
  cursor: pointer; text-decoration: underline; transition: all 0.3s;
}
.unlock-forgot-btn:hover { color: #f59e0b; transform: scale(1.05); }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}
.shake-error { animation: shake 0.5s; }

.security-question-select {
  width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px; padding: 12px 14px; color: #fff; font-size: 0.95rem;
  font-family: inherit; transition: all 0.3s;
}
.security-question-select:focus { outline: 0; background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.25); }
.security-question-select option { background: #1a1a1a; color: #fff; }

.recovery-key-display {
  background: rgba(251,191,36,0.1); border: 2px solid rgba(251,191,36,0.3);
  border-radius: 16px; padding: 24px; margin: 20px 0;
  font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: 700;
  color: #fbbf24; line-height: 1.8; word-break: break-word; user-select: all;
}

.recovery-option-buttons { display: flex; flex-direction: column; gap: 16px; margin: 30px 0; }
.recovery-option-btn {
  display: flex; align-items: center; gap: 20px; padding: 20px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 16px; cursor: pointer; transition: all 0.3s; text-align: left;
}
.recovery-option-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); transform: translateY(-2px); }
.recovery-option-btn.danger { border-color: rgba(239,68,68,0.3); }
.recovery-option-btn.danger:hover { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.5); }
.recovery-icon { font-size: 2.5rem; flex-shrink: 0; }
.recovery-text { flex: 1; }
.recovery-text strong { display: block; font-size: 1.1rem; color: #fff; margin-bottom: 5px; }
.recovery-text span { display: block; font-size: 0.85rem; color: rgba(255,255,255,0.6); }

/* Swipe Gestures */
@keyframes swipeIndicator {
  0% { opacity: 0; transform: translateY(-50%) scale(0.3); }
  40% { opacity: 1; transform: translateY(-50%) scale(1.3); }
  100% { opacity: 0; transform: translateY(-50%) scale(0.5); }
}
.pane {
  position: relative; overflow: visible !important; touch-action: pan-y;
  user-select: none; will-change: transform, opacity;
}
.pane::before, .pane::after {
  position: absolute; top: 50%; transform: translateY(-50%);
  font-size: 2.5rem; color: rgba(251,191,36,0.15); font-weight: 900;
  pointer-events: none; z-index: 1; transition: all 0.3s;
}
.pane::before { content: '‚Äπ'; left: 15px; }
.pane::after { content: '‚Ä∫'; right: 15px; }
@media (hover: hover) {
  .pane:hover::before, .pane:hover::after {
    color: rgba(251,191,36,0.35); text-shadow: 0 0 10px rgba(251,191,36,0.3);
  }
}

@media (max-width: 768px) {
  .passcode-digit { width: 45px !important; height: 55px; font-size: 1.6rem; }
  .passcode-input-group { gap: 8px; }
  .lock-container { padding: 30px 20px; }
  .recovery-key-display { font-size: 0.95rem; padding: 16px; }
}


/* Remove decorative line from Monthly Utilities pane */
.pane.monthly::before {
  display: none !important;
}

/* Notification Toggle Switch */
#notifications-toggle:checked + span {
  background: linear-gradient(135deg, #10b981, #059669);
}
#notifications-toggle:checked + span + span {
  transform: translateX(26px);
}
</style>
</head>
<body>
<div class="app-header"><div class="app-logo">üí∞</div><h1 class="app-title">Expense Tracker</h1></div>
<div class="container">
<div class="sync-bar">
<button class="sync-btn settings" onclick="showSettings()">‚öôÔ∏è Settings</button>
<button class="sync-btn insights" onclick="showInsights()">üìà Insights</button>
<button class="sync-btn analytics" onclick="showAnalytics()">üìä Analytics</button>
<button class="sync-btn export" onclick="exportData()">üì• Export</button>
<button class="sync-btn import" onclick="document.getElementById('import-file').click()">üì§ Import</button>
<button class="sync-btn danger" onclick="resetApp()">üîÑ Reset</button>
<input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
</div>
<div class="pane" id="pane-period">
<div class="pane-header"><div class="period-nav"><button onclick="changePeriod(-1)">‚óÄ</button><div class="period-title" id="period-dates">Loading...</div><button onclick="changePeriod(1)">‚ñ∂</button></div><div class="star-toggle" id="star-current" onclick="jumpToCurrent()">‚≠ê</div></div>
<div class="summary">
<div class="summary-item"><div class="summary-label">Salary</div><div class="summary-value" id="salary-display">$0</div></div>
<div class="summary-item"><div class="summary-label">Expenses</div><div class="summary-value" id="expenses-display">$0</div></div>
<div class="summary-item"><div class="summary-label">This Period Savings</div><div class="summary-value" id="savings-display">$0</div></div>
<div class="summary-item"><div class="summary-label">Previous Balance</div><div class="summary-value info" id="carry-forward-display">$0</div></div>
<div class="summary-item full-width"><div class="summary-label">Total Cumulative Savings</div><div class="summary-value" id="total-savings-display">$0</div></div>
</div>
<div class="input-group"><label class="input-label">Salary</label><input type="number" id="salary-input" placeholder="Enter salary" step="0.01"></div>
<div class="input-group"><label class="input-label">Category</label><input type="text" id="category-input" placeholder="e.g., Groceries, Rent"></div>
<div class="input-group"><label class="input-label">Amount</label><input type="number" id="amount-input" placeholder="0.00" step="0.01"></div>
<button class="btn" onclick="addExpense()">Add Expense</button>
<div class="quick-add-section"><div class="quick-add-label">Quick Add:</div><div class="quick-add-buttons" id="quick-add-buttons"></div></div>
<div class="expenses-list" id="expenses-list"><div class="empty-state"><div class="empty-state-icon">üìä</div><div>No expenses yet</div></div></div>
</div>
<div class="pane monthly">
<div class="pane-header"><div class="pane-title">Monthly Utilities</div></div>
<div class="month-nav"><button onclick="changeMonth(-1)">‚óÄ</button><div class="month-display" id="month-display">Loading...</div><button onclick="changeMonth(1)">‚ñ∂</button></div>
    <div id="utility-disclaimer" style="background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:12px;padding:16px;margin:16px 0 20px 0;display:none;">
      <div style="display:flex;align-items:start;gap:12px;">
        <span style="font-size:1.5rem;flex-shrink:0;">üìä</span>
        <div style="flex:1;">
          <div style="font-weight:700;color:#8b5cf6;margin-bottom:6px;font-size:0.95rem;">üìå Tracking Only - Not Added to Expenses</div>
          <p style="margin:0;font-size:0.85rem;line-height:1.6;color:rgba(255,255,255,0.85);">
            This section is for <strong style="color:#8b5cf6;">tracking your monthly utility bills</strong> and viewing analytics. 
            <span style="display:block;margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;border-left:3px solid rgba(239,68,68,0.5);">
              <strong style="color:#ef4444;">‚ö†Ô∏è Not Auto-Added:</strong> These utilities are <strong>NOT automatically included</strong> in your bi-weekly expenses.
            </span>
            <span style="display:block;margin-top:8px;color:rgba(255,255,255,0.7);font-size:0.8rem;">
              üí° <em>To track a utility payment in your bi-weekly budget, add it manually as a regular expense.</em>
            </span>
          </p>
          <div style="display:flex;gap:10px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(139,92,246,0.2);flex-wrap:wrap;">
            <button onclick="dismissUtilityDisclaimer(false)" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all 0.3s;">
              Got it
            </button>
            <button onclick="dismissUtilityDisclaimer(true)" style="background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4);color:#8b5cf6;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all 0.3s;">
              Don't show again
            </button>
          </div>
        </div>
        <button onclick="dismissUtilityDisclaimer(false)" style="background:none;border:none;color:rgba(255,255,255,0.5);font-size:1.5rem;cursor:pointer;padding:0;margin:0;line-height:1;transition:color 0.3s;" onmouseover="this.style.color='rgba(255,255,255,0.9)'" onmouseout="this.style.color='rgba(255,255,255,0.5)'">√ó</button>
      </div>
    </div>

<div class="summary"><div class="summary-item full-width"><div class="summary-label">Total Bills</div><div class="summary-value" id="monthly-total">$0</div></div></div>
<div class="input-group"><label class="input-label">Utility Type</label><select id="utility-type"><option value="">Select utility...</option><option value="üíß Water">üíß Water</option><option value="üî• Gas">üî• Gas</option><option value="‚ö° Hydro">‚ö° Hydro</option><option value="üì° Internet">üì° Internet</option><option value="üì± Phone">üì± Phone</option><option value="üè† Home Insurance">üè† Home Insurance</option><option value="üöó Car Insurance">üöó Car Insurance</option><option value="Other">Other</option></select></div>
<div class="input-group" id="custom-utility-group" style="display:none"><label class="input-label">Custom Utility</label><input type="text" id="custom-utility" placeholder="Enter utility name"></div>
<div class="input-group"><label class="input-label">Amount</label><input type="number" id="utility-amount" placeholder="0.00" step="0.01"></div>
<button class="btn" onclick="addUtility()">Add Utility</button>
<div class="expenses-list" id="utilities-list"><div class="empty-state"><div class="empty-state-icon">üí°</div><div>No utilities yet</div></div></div>
</div>
</div>
<div id="setup-wizard" class="modal setup-wizard"><div class="modal-content"><div class="modal-header"><div class="modal-title">Welcome! üëã</div></div><div class="wizard-icon">üí∞</div><p class="wizard-subtitle">Let's get you set up! When does your bi-weekly pay cycle start? This helps us track your expenses accurately across pay periods.</p><div class="quick-dates" id="quick-dates"></div><div class="divider">OR CHOOSE A DATE</div><div class="input-group"><label class="input-label">Custom Start Date</label><input type="date" id="setup-start-date" max="2099-12-31"></div><div class="modal-buttons"><button class="modal-btn save" onclick="completeSetup()">Get Started! üöÄ</button></div><p style="margin-top:20px;font-size:.85rem;color:rgba(255,255,255,.5)">üí° Tip: Choose the first day of any recent pay period.</p></div></div>
<div id="settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Settings ‚öôÔ∏è</div><button class="close-btn" onclick="closeSettings()">‚úï</button></div><div class="settings-info"><div class="settings-info-title">Current Pay Cycle Start</div><div class="settings-info-value" id="current-start-date">Loading...</div></div><div class="input-group"><label class="input-label">Update Pay Cycle Start Date</label><input type="date" id="settings-start-date" max="2099-12-31"></div><div class="divider" style="margin:30px 0">üîê Security</div>
<div class="settings-info" style="background:rgba(251,191,36,.1);border-color:rgba(251,191,36,.3)">
  <div class="settings-info-title">Change Passcode</div>
  <div class="settings-info-value" style="color:#fbbf24">Update your 6-digit PIN</div>
</div>
<div class="input-group">
  <label class="input-label">Current Passcode (6 digits)</label>
  <input type="password" id="current-passcode-settings" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
</div>
<div class="input-group">
  <label class="input-label">New Passcode (6 digits)</label>
  <input type="password" id="new-passcode-settings" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
</div>
<div class="input-group">
  <label class="input-label">Confirm New Passcode</label>
  <input type="password" id="confirm-passcode-settings" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
</div>
<button class="sync-btn" style="width:100%;margin-bottom:30px;background:linear-gradient(135deg,rgba(251,191,36,.25),rgba(251,191,36,.15));border-color:rgba(251,191,36,.4)" onclick="changePasscodeSettings()">üîí Update Passcode</button>

      <div class="divider" style="margin:30px 0">üîë Recovery Code</div>

      <div style="background:rgba(59,130,246,0.15);border:2px solid rgba(59,130,246,0.4);border-radius:16px;padding:24px;margin:20px 0">
        <div style="font-size:1.1rem;font-weight:700;color:#3b82f6;margin-bottom:12px">
          Generate New Recovery Code
        </div>
        <p style="font-size:0.9rem;color:rgba(255,255,255,0.85);line-height:1.6;margin:12px 0 16px 0">
          Lost your recovery code email? Generate a new one here. You'll need your current PIN to verify.
        </p>
        <button class="modal-btn save" style="width:100%;background:linear-gradient(135deg,rgba(59,130,246,0.3),rgba(59,130,246,0.2));border-color:rgba(59,130,246,0.5)" onclick="showRegenerateRecoveryCode()">
          üîë Generate New Recovery Code
        </button>
      </div>



    <div class="divider" style="margin:30px 0">üîî Push Notifications</div>
    <div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:16px;margin-bottom:20px;">
      <div style="font-size:0.85rem;color:rgba(255,255,255,0.8);line-height:1.6;">
        <strong style="color:#fbbf24;">üì± Get reminded about expenses!</strong><br>
        Enable notifications to receive reminders at the start of each pay period.
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;margin-bottom:12px;">
      <div>
        <div style="font-weight:600;margin-bottom:4px;">Enable Notifications</div>
        <div style="font-size:0.75rem;color:rgba(255,255,255,0.6);">Get pay period reminders</div>
      </div>
      <label style="position:relative;display:inline-block;width:60px;height:34px;">
        <input type="checkbox" id="notifications-toggle" onchange="toggleNotifications()" style="opacity:0;width:0;height:0;">
        <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.1);transition:0.4s;border-radius:34px;"></span>
        <span style="position:absolute;content:'';height:26px;width:26px;left:4px;bottom:4px;background:white;transition:0.4s;border-radius:50%;"></span>
      </label>
    </div>
    <div id="notification-status" style="font-size:0.85rem;color:rgba(255,255,255,0.6);padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;display:none;">
      <span id="notification-status-text"></span>
    </div>
<div class="divider" style="margin:30px 0">üìÖ Pay Cycle Settings</div>
<div class="warning-box"><p>‚ö†Ô∏è <strong>Important:</strong> Changing your pay cycle start date will recalculate all periods.</p></div><div class="modal-buttons"><button class="modal-btn cancel" onclick="closeSettings()">Cancel</button><button class="modal-btn save" onclick="saveSettings()">Save Changes</button></div></div></div>
<div id="edit-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Edit Expense</div><button class="close-btn" onclick="closeEditModal()">‚úï</button></div><div class="input-group"><label class="input-label">Category</label><input type="text" id="edit-category" placeholder="e.g., Groceries"></div><div class="input-group"><label class="input-label">Amount</label><input type="number" id="edit-amount" placeholder="0.00" step="0.01"></div><div class="modal-buttons"><button class="modal-btn cancel" onclick="closeEditModal()">Cancel</button><button class="modal-btn save" onclick="saveEdit()">Save Changes</button></div></div></div>
<div id="analytics-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Utility Analytics</div><button class="close-btn" onclick="closeAnalytics()">‚úï</button></div><div id="analytics-body"></div></div></div>
<div id="insights-modal" class="modal"><div class="modal-content insights-content"><div class="modal-header"><div class="modal-title">Spending Insights üìà</div><button class="close-btn" onclick="closeInsights()">‚úï</button></div><div id="insights-body" class="insights-body"></div></div></div>
<script>let transactions=[],salaries={},utilities=[],settings=null,currentPeriodOffset=0,currentMonthOffset=0,editingItem=null,editingType=null,selectedQuickDate=null;function loadData(){try{transactions=JSON.parse(localStorage.getItem('transactions')||'[]'),salaries=JSON.parse(localStorage.getItem('salaries')||'{}'),utilities=JSON.parse(localStorage.getItem('utilities')||'[]'),settings=JSON.parse(localStorage.getItem('paySettings')||'null')}catch(e){console.error('Error loading data:',e),alert('Data loading error. Try clicking Reset.')}}function resetApp(){confirm('‚ö†Ô∏è Delete ALL data and restart setup?')&&(localStorage.clear(),location.reload())}function checkFirstTimeUser(){settings&&settings.startDate?(updatePeriodDisplay(),updateMonthlyDisplay(),renderQuickAddButtons()):showSetupWizard()}function showSetupWizard(){generateQuickDates(),document.getElementById('setup-wizard').classList.add('active')}function generateQuickDates(){const container=document.getElementById('quick-dates'),today=new Date(),dates=[];for(let i=0;i<4;i++){const date=new Date(today);date.setDate(date.getDate()-i*14);const dayOfWeek=date.getDay(),daysToMonday=0===dayOfWeek?-6:1-dayOfWeek;date.setDate(date.getDate()+daysToMonday),dates.push(date)}container.innerHTML=dates.map((date,index)=>{const formatted=date.toISOString().split('T')[0],display=date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),label=0===index?' (This Week)':'';return`<button class="quick-date-btn" onclick="selectQuickDate('${formatted}')">${display}${label}</button>`}).join('')}function selectQuickDate(dateStr){selectedQuickDate=dateStr,document.getElementById('setup-start-date').value=dateStr,document.querySelectorAll('.quick-date-btn').forEach(btn=>btn.classList.remove('selected')),event.target.classList.add('selected')}function completeSetup(){let startDate=document.getElementById('setup-start-date').value||selectedQuickDate;startDate?(settings={startDate:startDate,setupComplete:!0,setupDate:(new Date).toISOString()},localStorage.setItem('paySettings',JSON.stringify(settings)),document.getElementById('setup-wizard').classList.remove('active'),currentPeriodOffset=0,updatePeriodDisplay(),updateMonthlyDisplay(),renderQuickAddButtons()):alert('Please select a start date')}function showSettings(){if(!settings||!settings.startDate)return void alert('Complete setup first');const modal=document.getElementById('settings-modal'),dateObj=new Date(settings.startDate+'T00:00:00');document.getElementById('current-start-date').textContent=dateObj.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}),document.getElementById('settings-start-date').value=settings.startDate,modal.classList.add('active')}function closeSettings(){document.getElementById('settings-modal').classList.remove('active')}function saveSettings(){const newStartDate=document.getElementById('settings-start-date').value;newStartDate?confirm('Change pay cycle start date? This recalculates all periods.')&&(settings.startDate=newStartDate,settings.lastModified=(new Date).toISOString(),localStorage.setItem('paySettings',JSON.stringify(settings)),currentPeriodOffset=0,updatePeriodDisplay(),closeSettings(),alert('‚úÖ Pay cycle updated!')):alert('Enter a valid start date')}document.getElementById('utility-type').addEventListener('change',function(){document.getElementById('custom-utility-group').style.display='Other'===this.value?'block':'none'});function showAnalytics(){const modal=document.getElementById('analytics-modal'),body=document.getElementById('analytics-body'),utilityGroups={};utilities.forEach(util=>{utilityGroups[util.type]||(utilityGroups[util.type]=[]),utilityGroups[util.type].push(util.amount)});const analytics=Object.keys(utilityGroups).map(type=>{const amounts=utilityGroups[type],sum=amounts.reduce((acc,curr)=>acc+curr,0);return{type:type,count:amounts.length,average:sum/amounts.length,total:sum}}).sort((a,b)=>b.average-a.average);if(0===analytics.length)body.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No utility data yet</div></div>';else{const totalAvg=analytics.reduce((sum,item)=>sum+item.average,0);body.innerHTML=`<table class="analytics-table"><thead><tr><th>Utility</th><th>Months</th><th>Total</th><th>Average</th></tr></thead><tbody>${analytics.map(item=>`<tr><td>${item.type}</td><td>${item.count}</td><td>$${item.total.toFixed(2)}</td><td>$${item.average.toFixed(2)}</td></tr>`).join('')}</tbody><tfoot><tr style="border-top:2px solid rgba(255,255,255,.2);font-weight:700"><td>Total Monthly Average</td><td></td><td></td><td style="font-size:1.1rem">$${totalAvg.toFixed(2)}</td></tr></tfoot></table>`}modal.classList.add('active')}function closeAnalytics(){document.getElementById('analytics-modal').classList.remove('active')}function showInsights(){const modal=document.getElementById('insights-modal'),body=document.getElementById('insights-body'),currentPeriod=getPeriod(0),previousPeriod=getPeriod(-1);if(!currentPeriod)return body.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No data available</div></div>',void modal.classList.add('active');const currentExpenses=transactions.filter(t=>{const tDate=new Date(t.date);return tDate.setHours(0,0,0,0),tDate>=currentPeriod.start&&tDate<=currentPeriod.end}),previousExpenses=previousPeriod?transactions.filter(t=>{const tDate=new Date(t.date);return tDate.setHours(0,0,0,0),tDate>=previousPeriod.start&&tDate<=previousPeriod.end}):[],currentCategories=getCategoryBreakdown(currentExpenses),previousTotal=previousExpenses.reduce((sum,t)=>sum+t.amount,0),currentTotal=currentExpenses.reduce((sum,t)=>sum+t.amount,0),currentSalary=salaries[currentPeriod.key]||0,previousSalary=previousPeriod?salaries[previousPeriod.key]||0:0,currentSavings=currentSalary-currentTotal,previousSavings=previousSalary-previousTotal,allTimeStats=calculateAllTimeStats();let html='';if(html+=`<div class="insight-section"><div class="insight-title">üí∞ This Pay Period</div>${currentCategories.length>0?`<div class="category-breakdown">${currentCategories.slice(0,3).map(cat=>`<div class="category-item"><span class="category-name">${cat.category}</span><span class="category-amount">$${cat.amount.toFixed(2)}</span></div>`).join('')}</div>`:'<p style="color:rgba(255,255,255,.5);text-align:center">No expenses yet this period</p>'}</div>`,previousPeriod){const expenseChange=currentTotal-previousTotal,expenseChangePercent=previousTotal>0?expenseChange/previousTotal*100:0,savingsChange=currentSavings-previousSavings;html+=`<div class="insight-section"><div class="insight-title">üìä vs Last Period</div><div class="insight-card"><span class="insight-label">Total Expenses</span><div><span class="insight-value">$${currentTotal.toFixed(0)}</span>${Math.abs(expenseChangePercent)>0?`<span class="insight-trend ${expenseChange>0?'up':'down'}">${expenseChange>0?'‚Üë':'‚Üì'} ${Math.abs(expenseChangePercent).toFixed(0)}%</span>`:''}</div></div><div class="insight-card"><span class="insight-label">Savings Change</span><div><span class="insight-value" style="color:${savingsChange>=0?'#10b981':'#ef4444'}">${savingsChange>=0?'+':''}$${savingsChange.toFixed(0)}</span></div></div></div>`}html+=`<div class="insight-section"><div class="insight-title">üéØ All-Time Stats</div><div class="stat-grid"><div class="stat-card"><div class="stat-label">Periods Tracked</div><div class="stat-value">${allTimeStats.periodsTracked}</div></div><div class="stat-card"><div class="stat-label">Avg Savings</div><div class="stat-value" style="color:${allTimeStats.avgSavings>=0?'#10b981':'#ef4444'}">$${allTimeStats.avgSavings.toFixed(0)}</div></div><div class="stat-card"><div class="stat-label">Best Period</div><div class="stat-value" style="color:#fbbf24;font-size:1.2rem">$${allTimeStats.bestSavings.toFixed(0)}</div></div><div class="stat-card"><div class="stat-label">Total Saved</div><div class="stat-value" style="color:${allTimeStats.totalSavings>=0?'#10b981':'#ef4444'}">$${allTimeStats.totalSavings.toFixed(0)}</div></div></div></div>`,allTimeStats.topCategories.length>0&&(html+=`<div class="insight-section"><div class="insight-title">üèÜ Top Spending Categories</div><div class="category-breakdown">${allTimeStats.topCategories.slice(0,5).map((cat,idx)=>`<div class="category-item"><span class="category-name">${idx+1}. ${cat.category}</span><span class="category-amount">$${cat.total.toFixed(0)}</span></div>`).join('')}</div></div>`),body.innerHTML=html,modal.classList.add('active')}function closeInsights(){document.getElementById('insights-modal').classList.remove('active')}function getCategoryBreakdown(expenses){const categories={};return expenses.forEach(exp=>{categories[exp.category]||(categories[exp.category]=0),categories[exp.category]+=exp.amount}),Object.keys(categories).map(cat=>({category:cat,amount:categories[cat]})).sort((a,b)=>b.amount-a.amount)}function calculateAllTimeStats(){if(!settings||!settings.startDate)return{periodsTracked:0,avgSavings:0,bestSavings:0,totalSavings:0,topCategories:[]};const today=new Date;today.setHours(0,0,0,0);const startDate=new Date(settings.startDate+'T00:00:00');startDate.setHours(0,0,0,0);const daysSinceStart=Math.floor((today-startDate)/864e5),totalPeriods=Math.floor(daysSinceStart/14)+1;let periodsWithData=0,totalSavings=0,bestSavings=-Infinity;const allCategories={};for(let i=0;i<totalPeriods;i++){const periodStart=new Date(startDate);periodStart.setDate(periodStart.getDate()+14*i);const periodEnd=new Date(periodStart);periodEnd.setDate(periodEnd.getDate()+13),periodEnd.setHours(23,59,59,999);const periodKey=`period-${periodStart.getFullYear()}-${String(periodStart.getMonth()+1).padStart(2,'0')}-${String(periodStart.getDate()).padStart(2,'0')}`,salary=salaries[periodKey]||0,periodExpenses=transactions.filter(t=>{const tDate=new Date(t.date);return tDate.setHours(0,0,0,0),tDate>=periodStart&&tDate<=periodEnd});if(salary>0||periodExpenses.length>0){periodsWithData++;const expenseTotal=periodExpenses.reduce((sum,t)=>sum+t.amount,0),savings=salary-expenseTotal;totalSavings+=savings,savings>bestSavings&&(bestSavings=savings),periodExpenses.forEach(exp=>{allCategories[exp.category]||(allCategories[exp.category]=0),allCategories[exp.category]+=exp.amount})}}const topCategories=Object.keys(allCategories).map(cat=>({category:cat,total:allCategories[cat]})).sort((a,b)=>b.total-a.total);return{periodsTracked:periodsWithData,avgSavings:periodsWithData>0?totalSavings/periodsWithData:0,bestSavings:-Infinity===bestSavings?0:bestSavings,totalSavings:totalSavings,topCategories:topCategories}}function getTopCategories(limit=5){if(0===transactions.length)return[];const categoryFrequency={};return transactions.forEach(t=>{const cat=t.category.trim();cat&&(categoryFrequency[cat]=(categoryFrequency[cat]||0)+1)}),Object.keys(categoryFrequency).map(cat=>({category:cat,count:categoryFrequency[cat]})).sort((a,b)=>b.count-a.count).slice(0,limit).map(item=>item.category)}function renderQuickAddButtons(){const container=document.getElementById('quick-add-buttons'),topCategories=getTopCategories(5);if(0===topCategories.length)return void(container.innerHTML='<div class="quick-add-empty">Add some expenses to see quick categories</div>');const categoryEmojis={Groceries:'üõí',Gas:'‚õΩ',Coffee:'‚òï',Food:'üçî',Restaurant:'üçΩÔ∏è',Transport:'üöó',Shopping:'üõçÔ∏è',Entertainment:'üé¨',Bills:'üìÑ',Rent:'üè†',Utilities:'üí°',Health:'‚öïÔ∏è',Gym:'üí™',Subscription:'üì±'};container.innerHTML=topCategories.map(category=>{let emoji='';const categoryLower=category.toLowerCase();for(const[key,value]of Object.entries(categoryEmojis))if(categoryLower.includes(key.toLowerCase())){emoji=value;break}return`<button class="quick-add-btn" onclick="quickAddCategory('${category.replace(/'/g,"\'")}')"> ${emoji?emoji+' ':''}${category}</button>`}).join('')}function quickAddCategory(category){document.getElementById('category-input').value=category;const amountInput=document.getElementById('amount-input');amountInput.focus(),amountInput.select();const categoryInput=document.getElementById('category-input');categoryInput.style.background='rgba(251,191,36,.15)',setTimeout(()=>{categoryInput.style.background=''},500)}function openEditModal(id,type){editingType=type,'expense'===type?(editingItem=transactions.find(t=>t.id===id),editingItem&&(document.getElementById('edit-category').value=editingItem.category,document.getElementById('edit-amount').value=editingItem.amount,document.querySelector('#edit-modal .modal-title').textContent='Edit Expense')):'utility'===type&&(editingItem=utilities.find(u=>u.id===id),editingItem&&(document.getElementById('edit-category').value=editingItem.type,document.getElementById('edit-amount').value=editingItem.amount,document.querySelector('#edit-modal .modal-title').textContent='Edit Utility')),document.getElementById('edit-modal').classList.add('active')}function closeEditModal(){document.getElementById('edit-modal').classList.remove('active'),editingItem=null,editingType=null}function saveEdit(){if(!editingItem)return;const newCategory=document.getElementById('edit-category').value.trim(),newAmount=parseFloat(document.getElementById('edit-amount').value);if(!newCategory||!newAmount||newAmount<=0)return void alert('Enter valid category and amount');if('expense'===editingType){const index=transactions.findIndex(t=>t.id===editingItem.id);-1!==index&&(transactions[index].category=newCategory,transactions[index].amount=newAmount,localStorage.setItem('transactions',JSON.stringify(transactions)),updatePeriodDisplay(),renderQuickAddButtons())}else if('utility'===editingType){const index=utilities.findIndex(u=>u.id===editingItem.id);-1!==index&&(utilities[index].type=newCategory,utilities[index].amount=newAmount,localStorage.setItem('utilities',JSON.stringify(utilities)),updateMonthlyDisplay())}closeEditModal()}window.onclick=function(event){event.target===document.getElementById('analytics-modal')&&closeAnalytics(),event.target===document.getElementById('insights-modal')&&closeInsights(),event.target===document.getElementById('edit-modal')&&closeEditModal(),event.target===document.getElementById('settings-modal')&&closeSettings()};function exportData(){const data={transactions:transactions,salaries:salaries,utilities:utilities,settings:settings,exportDate:(new Date).toISOString(),version:'3.0'},blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),url=URL.createObjectURL(blob),link=document.createElement('a');link.href=url,link.download=`expense-tracker-${(new Date).toISOString().split('T')[0]}.json`,link.click(),URL.revokeObjectURL(url),alert('‚úÖ Data exported!')}function importData(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=function(e){try{const imported=JSON.parse(e.target.result);confirm('Import data? This replaces current data.')&&(transactions=imported.transactions||[],salaries=imported.salaries||{},utilities=imported.utilities||[],settings=imported.settings||null,currentPeriodOffset=0,localStorage.setItem('transactions',JSON.stringify(transactions)),localStorage.setItem('salaries',JSON.stringify(salaries)),localStorage.setItem('utilities',JSON.stringify(utilities)),settings&&localStorage.setItem('paySettings',JSON.stringify(settings)),updatePeriodDisplay(),updateMonthlyDisplay(),renderQuickAddButtons(),alert('‚úÖ Data imported!'))}catch(error){alert('‚ùå Invalid file')}},reader.readAsText(file),event.target.value=''}function changePeriod(direction){currentPeriodOffset+=direction,updatePeriodDisplay()}function jumpToCurrent(){currentPeriodOffset=0,updatePeriodDisplay()}function getPeriod(offset=0){try{if(!settings||!settings.startDate)return null;const today=new Date;today.setHours(0,0,0,0);const startDate=new Date(settings.startDate+'T00:00:00');if(isNaN(startDate.getTime()))return alert('Invalid start date. Reset app.'),null;startDate.setHours(0,0,0,0);const millisDiff=today.getTime()-startDate.getTime(),daysDiff=Math.floor(millisDiff/864e5),currentPeriodNum=Math.floor(daysDiff/14),targetPeriod=currentPeriodNum+offset,periodStart=new Date(startDate);periodStart.setDate(periodStart.getDate()+14*targetPeriod);const periodEnd=new Date(periodStart);return periodEnd.setDate(periodEnd.getDate()+13),periodEnd.setHours(23,59,59,999),{start:periodStart,end:periodEnd,key:`period-${periodStart.getFullYear()}-${String(periodStart.getMonth()+1).padStart(2,'0')}-${String(periodStart.getDate()).padStart(2,'0')}`,periodNum:targetPeriod}}catch(error){return console.error('Error in getPeriod:',error),null}}function getMonth(offset=0){const today=new Date,month=new Date(today.getFullYear(),today.getMonth()+offset,1);return{year:month.getFullYear(),month:month.getMonth(),key:`${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`,display:month.toLocaleDateString('en-US',{month:'long',year:'numeric'})}}function formatDateShort(date){return date.toLocaleDateString('en-US',{month:'short',day:'numeric'})}function changeMonth(direction){currentMonthOffset+=direction,updateMonthlyDisplay()}function calculateCarryForward(upToPeriodNum){if(!settings||!settings.startDate)return 0;if(upToPeriodNum<=0)return 0;let cumulativeSavings=0;const startDate=new Date(settings.startDate+'T00:00:00');startDate.setHours(0,0,0,0);for(let i=0;i<upToPeriodNum;i++){const periodStart=new Date(startDate);periodStart.setDate(periodStart.getDate()+14*i);const periodEnd=new Date(periodStart);periodEnd.setDate(periodEnd.getDate()+13),periodEnd.setHours(23,59,59,999);const periodKey=`period-${periodStart.getFullYear()}-${String(periodStart.getMonth()+1).padStart(2,'0')}-${String(periodStart.getDate()).padStart(2,'0')}`,salary=salaries[periodKey]||0,periodExpenses=transactions.filter(t=>{const tDate=new Date(t.date);return tDate.setHours(0,0,0,0),tDate>=periodStart&&tDate<=periodEnd}),totalExpenses=periodExpenses.reduce((sum,t)=>sum+t.amount,0);cumulativeSavings+=salary-totalExpenses}return cumulativeSavings}function updatePeriodDisplay(){const period=getPeriod(currentPeriodOffset);if(!period)return;const pane=document.getElementById('pane-period'),star=document.getElementById('star-current'),dateRange=`${formatDateShort(period.start)} - ${formatDateShort(period.end)}`,isCurrent=0===currentPeriodOffset;document.getElementById('period-dates').textContent=isCurrent?`${dateRange} (CURRENT)`:dateRange,isCurrent?(star.classList.add('active'),pane.classList.add('current')):(star.classList.remove('active'),pane.classList.remove('current'));const salary=salaries[period.key]||0;document.getElementById('salary-input').value=salary||'';const periodExpenses=transactions.filter(t=>{const tDate=new Date(t.date);return tDate.setHours(0,0,0,0),tDate>=period.start&&tDate<=period.end}),totalExpenses=periodExpenses.reduce((sum,t)=>sum+t.amount,0),thisPeriodSavings=salary-totalExpenses,carryForward=calculateCarryForward(period.periodNum),totalCumulativeSavings=carryForward+thisPeriodSavings;document.getElementById('salary-display').textContent=`$${salary.toFixed(0)}`,document.getElementById('expenses-display').textContent=`$${totalExpenses.toFixed(0)}`;const savingsEl=document.getElementById('savings-display');savingsEl.textContent=`$${thisPeriodSavings.toFixed(0)}`,savingsEl.className='summary-value '+(thisPeriodSavings>=0?'positive':'negative');const carryForwardEl=document.getElementById('carry-forward-display');carryForwardEl.textContent=`$${carryForward.toFixed(0)}`,carryForwardEl.className='summary-value info '+(carryForward>=0?'positive':'negative');const totalSavingsEl=document.getElementById('total-savings-display');totalSavingsEl.textContent=`$${totalCumulativeSavings.toFixed(0)}`,totalSavingsEl.className='summary-value '+(totalCumulativeSavings>=0?'positive':'negative'),renderExpenses(periodExpenses)}function updateMonthlyDisplay(){const month=getMonth(currentMonthOffset);document.getElementById('month-display').textContent=month.display;const monthUtilities=utilities.filter(u=>u.month===month.key),total=monthUtilities.reduce((sum,u)=>sum+u.amount,0);document.getElementById('monthly-total').textContent=`$${total.toFixed(0)}`,renderUtilities(monthUtilities)}function renderExpenses(expenses){const listEl=document.getElementById('expenses-list');if(0===expenses.length)return void(listEl.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No expenses yet</div></div>');listEl.innerHTML=expenses.slice().reverse().map(exp=>`<div class="expense-item-wrapper"><div class="expense-item" data-expense-id="${exp.id}"><div class="expense-info"><div class="expense-desc">${exp.category}</div><div class="expense-cat">${new Date(exp.date).toLocaleDateString()}</div></div><div class="expense-amount">$${exp.amount.toFixed(2)}</div></div><div class="swipe-actions"><button class="action-btn edit"><span class="action-icon">‚úèÔ∏è</span><span>Edit</span></button><button class="action-btn delete"><span class="action-icon">üóëÔ∏è</span><span>Delete</span></button></div></div>`).join(''),listEl.querySelectorAll('.expense-item').forEach(item=>setupSwipeActions(item,'expense'))}function renderUtilities(utilityList){const listEl=document.getElementById('utilities-list');if(0===utilityList.length)return void(listEl.innerHTML='<div class="empty-state"><div class="empty-state-icon">üí°</div><div>No utilities yet</div></div>');listEl.innerHTML=utilityList.map(util=>`<div class="expense-item-wrapper"><div class="expense-item" data-utility-id="${util.id}"><div class="expense-info"><div class="expense-desc">${util.type}</div><div class="expense-cat">${util.month}</div></div><div class="expense-amount">$${util.amount.toFixed(2)}</div></div><div class="swipe-actions"><button class="action-btn edit"><span class="action-icon">‚úèÔ∏è</span><span>Edit</span></button><button class="action-btn delete"><span class="action-icon">üóëÔ∏è</span><span>Delete</span></button></div></div>`).join(''),listEl.querySelectorAll('.expense-item').forEach(item=>setupSwipeActions(item,'utility'))}function setupSwipeActions(item,type){let startX=0,currentX=0,isSwiping=!1;const swipeThreshold=60,wrapper=item.closest('.expense-item-wrapper'),editBtn=wrapper.querySelector('.action-btn.edit'),deleteBtn=wrapper.querySelector('.action-btn.delete');item.addEventListener('touchstart',e=>{startX=e.touches[0].clientX,isSwiping=!1,item.classList.remove('transitioning')},{passive:!0}),item.addEventListener('touchmove',e=>{if(!startX)return;currentX=e.touches[0].clientX;const diff=startX-currentX;Math.abs(diff)>5&&(isSwiping=!0),diff>0&&diff<160?item.style.transform=`translate3d(-${diff}px, 0, 0)`:diff<=0&&(item.style.transform='translate3d(0, 0, 0)')},{passive:!0}),item.addEventListener('touchend',e=>{if(!startX)return;const diff=startX-currentX;item.classList.add('transitioning'),isSwiping&&diff>swipeThreshold?(item.classList.add('swiped'),item.style.transform=''):(item.classList.remove('swiped'),item.style.transform=''),startX=0,currentX=0,isSwiping=!1},{passive:!0}),editBtn.addEventListener('click',e=>{e.stopPropagation();const id='expense'===type?parseInt(item.dataset.expenseId):parseInt(item.dataset.utilityId);openEditModal(id,type),item.classList.remove('swiped')}),deleteBtn.addEventListener('click',e=>{e.stopPropagation();const id='expense'===type?parseInt(item.dataset.expenseId):parseInt(item.dataset.utilityId);if(confirm('Delete this '+type+'?'))if('expense'===type){const index=transactions.findIndex(t=>t.id===id);-1!==index&&(transactions.splice(index,1),localStorage.setItem('transactions',JSON.stringify(transactions)),updatePeriodDisplay(),renderQuickAddButtons())}else{const index=utilities.findIndex(u=>u.id===id);-1!==index&&(utilities.splice(index,1),localStorage.setItem('utilities',JSON.stringify(utilities)),updateMonthlyDisplay())}}),document.addEventListener('click',e=>{wrapper.contains(e.target)||item.classList.remove('swiped')})}function addExpense(){const period=getPeriod(currentPeriodOffset);if(!period)return;const category=document.getElementById('category-input').value.trim(),amount=parseFloat(document.getElementById('amount-input').value);if(!category||!amount||amount<=0)return void alert('Enter both category and amount');const transaction={id:Date.now(),category:category,amount:amount,date:period.start.toISOString()};transactions.push(transaction),localStorage.setItem('transactions',JSON.stringify(transactions)),document.getElementById('category-input').value='',document.getElementById('amount-input').value='',updatePeriodDisplay(),renderQuickAddButtons()}function addUtility(){let type=document.getElementById('utility-type').value;if(!type)return void alert('Select a utility type');if('Other'===type&&(type=document.getElementById('custom-utility').value.trim(),!type))return void alert('Enter a custom utility name');const amount=parseFloat(document.getElementById('utility-amount').value);if(!amount||amount<=0)return void alert('Enter an amount');const month=getMonth(currentMonthOffset),utility={id:Date.now(),type:type,amount:amount,month:month.key};utilities.push(utility),localStorage.setItem('utilities',JSON.stringify(utilities)),document.getElementById('utility-type').value='',document.getElementById('custom-utility').value='',document.getElementById('utility-amount').value='',document.getElementById('custom-utility-group').style.display='none',updateMonthlyDisplay()}document.getElementById('salary-input').addEventListener('change',function(){const period=getPeriod(currentPeriodOffset);period&&(salaries[period.key]=parseFloat(this.value)||0,localStorage.setItem('salaries',JSON.stringify(salaries)),updatePeriodDisplay())}),document.getElementById('amount-input').addEventListener('keypress',function(e){'Enter'===e.key&&addExpense()}),document.getElementById('utility-amount').addEventListener('keypress',function(e){'Enter'===e.key&&addUtility()}),loadData(),checkFirstTimeUser();

// ==================== AUTHENTICATION SYSTEM ====================

let authSettings = {
  passcodeHash: null,
  recoveryCode: null,
  lockTimeout: 60000,
  isLocked: true
};
let lastActivityTime = Date.now();
let lockTimer = null;
let tempPasscode = null;

function hashCode(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash = hash & hash;
  }
  return hash.toString();
}

function loadAuthSettings() {
  const saved = localStorage.getItem('authSettings');
  if (saved) authSettings = JSON.parse(saved);
}

function setupPasscodeInputs() {
  document.querySelectorAll('.passcode-digit').forEach((input, index, inputs) => {
    input.addEventListener('input', (e) => {
      if (e.target.value.length === 1) {
        if (index < inputs.length - 1) inputs[index + 1].focus();
        else if (input.closest('#lock-screen')) attemptUnlock();
      }
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        inputs[index - 1].focus();
      }
    });
  });
}

function proceedToSecurityQuestions() {
  let passcode = '';
  for (let i = 1; i <= 6; i++) {
    passcode += document.getElementById(`setup-${i}`).value;
  }
  if (passcode.length !== 6 || !/^\d{6}$/.test(passcode)) {
    alert('‚ùå Please enter a 6-digit PIN');
    return;
  }
  tempPasscode = passcode;
  document.getElementById('passcode-setup-modal').classList.remove('active');
  document.getElementById('security-questions-modal').classList.add('active');
}





function completeAuthSetup() {
  let passcode = '';
  for (let i = 1; i <= 6; i++) {
    passcode += document.getElementById('setup-' + i).value;
  }
  if (passcode.length !== 6 || !/^\d{6}$/.test(passcode)) {
    alert('‚ùå Please enter a complete 6-digit PIN');
    return;
  }
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let recoveryCode = '';
  for (let i = 0; i < 4; i++) {
    recoveryCode += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  authSettings.passcodeHash = hashCode(passcode);
  authSettings.recoveryCode = hashCode(recoveryCode);
  authSettings.isLocked = false;
  localStorage.setItem('authSettings', JSON.stringify(authSettings));
  document.getElementById('passcode-setup-modal').classList.remove('active');
  document.getElementById('recovery-display-code').textContent = recoveryCode;
  document.getElementById('recovery-code-modal').classList.add('active');
  window.tempRecoveryCode = recoveryCode;
}

function attemptUnlock() {
  let enteredCode = '';
  for (let i = 1; i <= 6; i++) {
    enteredCode += document.getElementById(`unlock-${i}`).value;
  }
  if (enteredCode.length !== 6) return;

  if (hashCode(enteredCode) === authSettings.passcodeHash) {
    authSettings.isLocked = false;
    document.getElementById('lock-screen').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.querySelectorAll('.passcode-digit').forEach(input => input.value = '');
    document.getElementById('passcode-error').style.display = 'none';
    resetActivityTimer();
    if (navigator.vibrate) navigator.vibrate(50);
  } else {
    document.getElementById('passcode-error').style.display = 'block';
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
    const lockScreen = document.getElementById('lock-screen');
    lockScreen.classList.add('shake-error');
    setTimeout(() => lockScreen.classList.remove('shake-error'), 500);
    document.querySelectorAll('.passcode-digit').forEach(input => input.value = '');
    document.getElementById('unlock-1').focus();
  }
}

function lockApp() {
  if (!authSettings.passcodeHash) return;
  authSettings.isLocked = true;
  document.getElementById('lock-screen').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('unlock-1').focus(), 300);
}

function resetActivityTimer() {
  lastActivityTime = Date.now();
  if (lockTimer) clearTimeout(lockTimer);
  lockTimer = setTimeout(() => {
    if (!authSettings.isLocked) lockApp();
  }, authSettings.lockTimeout);
}


function changePasscodeSettings() {
  const currentPass = document.getElementById('current-passcode-settings').value;
  const newPass = document.getElementById('new-passcode-settings').value;
  const confirmPass = document.getElementById('confirm-passcode-settings').value;

  if (!currentPass || !newPass || !confirmPass) {
    alert('‚ùå Please fill in all fields');
    return;
  }

  if (currentPass.length !== 6 || newPass.length !== 6 || confirmPass.length !== 6) {
    alert('‚ùå Passcode must be exactly 6 digits');
    return;
  }

  if (!/^\d{6}$/.test(currentPass) || !/^\d{6}$/.test(newPass)) {
    alert('‚ùå Passcode must contain only numbers');
    return;
  }

  if (hashCode(currentPass) !== authSettings.passcodeHash) {
    alert('‚ùå Current passcode is incorrect');
    document.getElementById('current-passcode-settings').value = '';
    return;
  }

  if (newPass !== confirmPass) {
    alert('‚ùå New passcode and confirmation do not match');
    document.getElementById('new-passcode-settings').value = '';
    document.getElementById('confirm-passcode-settings').value = '';
    return;
  }

  if (newPass === currentPass) {
    alert('‚ùå New passcode must be different from current passcode');
    return;
  }

  authSettings.passcodeHash = hashCode(newPass);
  localStorage.setItem('authSettings', JSON.stringify(authSettings));

  document.getElementById('current-passcode-settings').value = '';
  document.getElementById('new-passcode-settings').value = '';
  document.getElementById('confirm-passcode-settings').value = '';

  alert('‚úÖ Passcode updated successfully!');

  if (navigator.vibrate) {
    navigator.vibrate([50, 30, 50]);
  }
}

function trackActivity() {
  if (!authSettings.isLocked) resetActivityTimer();
}









function verifySecurityAnswers() {
  const a1 = document.getElementById('recovery-a1').value.trim().toLowerCase();
  const a2 = document.getElementById('recovery-a2').value.trim().toLowerCase();

  if (hashCode(a1) === authSettings.securityQuestions.a1 && hashCode(a2) === authSettings.securityQuestions.a2) {
    alert('‚úÖ Verified! Create a new passcode.');
    closeSecurityRecovery();
    document.getElementById('lock-screen').style.display = 'none';
    for (let i = 1; i <= 6; i++) document.getElementById(`setup-${i}`).value = '';
    document.getElementById('passcode-setup-modal').classList.add('active');
  } else {
    document.getElementById('recovery-error').style.display = 'block';
  }
}







function confirmDataReset() {
  if (confirm('‚ö†Ô∏è Delete ALL data? This cannot be undone!')) {
    if (confirm('‚ùó Are you ABSOLUTELY SURE? All expenses, salaries, and settings will be lost forever!')) {
      localStorage.clear();
      location.reload();
    }
  }
}

function checkAuthSetup() {
  loadAuthSettings();
  if (!authSettings.passcodeHash) {
    for (let i = 1; i <= 6; i++) document.getElementById(`setup-${i}`).value = '';
    document.getElementById('passcode-setup-modal').classList.add('active');
  } else {
    lockApp();
  }
}


function emailRecoveryCode() {
  const code = window.tempRecoveryCode;
  const subject = encodeURIComponent('Expense Tracker - Recovery Code');
  const body = encodeURIComponent('Your PIN Recovery Code: ' + code + '\n\nSAVE THIS!');
  window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
  setTimeout(() => { window.tempRecoveryCode = null; }, 1000);
}
function closeRecoveryCodeModal() {
  document.getElementById('recovery-code-modal').classList.remove('active');
  window.tempRecoveryCode = null;
}
function showRecoveryCodeInput() {
  const modal = document.getElementById('recovery-input-modal');
  if (!modal) { alert('Error'); return; }
  for (let i = 1; i <= 4; i++) {
    const input = document.getElementById('recovery-' + i);
    if (input) input.value = '';
  }
  modal.classList.add('active');
  setTimeout(() => {
    setupRecoveryCodeInputs();
    document.getElementById('recovery-1')?.focus();
  }, 100);
}
function closeRecoveryInputModal() {
  document.getElementById('recovery-input-modal').classList.remove('active');
  for (let i = 1; i <= 4; i++) { document.getElementById('recovery-' + i).value = ''; }
}
function setupRecoveryCodeInputs() {
  for (let i = 1; i <= 4; i++) {
    const input = document.getElementById('recovery-' + i);
    if (!input) continue;
    input.addEventListener('input', function() {
      this.value = this.value.toUpperCase();
      if (this.value.length === 1 && i < 4) {
        document.getElementById('recovery-' + (i + 1)).focus();
      }
    });
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace' && this.value === '' && i > 1) {
        document.getElementById('recovery-' + (i - 1)).focus();
      }
    });
  }
}
function verifyRecoveryCode() {
  let code = '';
  for (let i = 1; i <= 4; i++) { code += document.getElementById('recovery-' + i).value; }
  if (code.length !== 4) { alert('‚ùå Enter complete code'); return; }
  if (hashCode(code) === authSettings.recoveryCode) {
    document.getElementById('recovery-input-modal').classList.remove('active');
    document.getElementById('new-pin-modal').classList.add('active');
    setupPasscodeInputs('newpin');
  } else {
    alert('‚ùå Incorrect code');
    for (let i = 1; i <= 4; i++) { document.getElementById('recovery-' + i).value = ''; }
    document.getElementById('recovery-1').focus();
  }
}
function saveNewPinAfterRecovery() {
  let pin = '';
  for (let i = 1; i <= 6; i++) { pin += document.getElementById('newpin-' + i).value; }
  if (pin.length !== 6 || !/^\d{6}$/.test(pin)) { alert('‚ùå Complete PIN'); return; }
  authSettings.passcodeHash = hashCode(pin);
  authSettings.isLocked = false;
  localStorage.setItem('authSettings', JSON.stringify(authSettings));
  document.getElementById('new-pin-modal').classList.remove('active');
  document.getElementById('lock-screen').style.display = 'none';
  alert('‚úÖ New PIN saved! Reloading app...');
  location.reload();
}
function resetAppFromLockScreen() {
  if (confirm('‚ö†Ô∏è DELETE ALL? Cannot be undone!')) {
    if (confirm('Final confirmation?')) { localStorage.clear(); location.reload(); }
  }
}
function showRegenerateRecoveryCode() {
  document.getElementById('regenerate-recovery-modal').classList.add('active');
  setupPasscodeInputs('verify');
  setTimeout(() => { document.getElementById('verify-1')?.focus(); }, 100);
}
function closeRegenerateModal() {
  document.getElementById('regenerate-recovery-modal').classList.remove('active');
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById('verify-' + i);
    if (input) input.value = '';
  }
}
function verifyPinAndGenerateNew() {
  let pin = '';
  for (let i = 1; i <= 6; i++) { pin += document.getElementById('verify-' + i).value; }
  if (pin.length !== 6 || !/^\d{6}$/.test(pin)) { alert('‚ùå Complete PIN'); return; }
  if (hashCode(pin) !== authSettings.passcodeHash) {
    alert('‚ùå Incorrect PIN');
    for (let i = 1; i <= 6; i++) { document.getElementById('verify-' + i).value = ''; }
    document.getElementById('verify-1').focus();
    return;
  }
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let newCode = '';
  for (let i = 0; i < 4; i++) { newCode += chars.charAt(Math.floor(Math.random() * chars.length)); }
  authSettings.recoveryCode = hashCode(newCode);
  localStorage.setItem('authSettings', JSON.stringify(authSettings));
  document.getElementById('new-recovery-display').textContent = newCode;
  window.tempRecoveryCode = newCode;
  document.getElementById('regenerate-recovery-modal').classList.remove('active');
  document.getElementById('new-recovery-code-modal').classList.add('active');
}
function closeNewRecoveryModal() {
  document.getElementById('new-recovery-code-modal').classList.remove('active');
  window.tempRecoveryCode = null;
}
function initAuth() {
  setupPasscodeInputs();
  checkAuthSetup();
  ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
    document.addEventListener(event, trackActivity, { passive: true });
  });
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      resetActivityTimer();
    } else {
      const idleTime = Date.now() - lastActivityTime;
      if (idleTime > authSettings.lockTimeout && authSettings.passcodeHash) lockApp();
    }
  });
}

// ==================== SWIPE GESTURES ====================

let swipeState = { startX: 0, startY: 0, currentX: 0, currentY: 0, isDragging: false, threshold: 80, element: null };

function initSwipeGestures() {
  const expensePane = document.getElementById('pane-period');
  setupSwipeListeners(expensePane, 'period');
  const utilityPane = document.querySelector('.pane.monthly');
  setupSwipeListeners(utilityPane, 'month');
}

function setupSwipeListeners(element, type) {
  if (!element) return;
  element.addEventListener('touchstart', (e) => handleSwipeStart(e, type), { passive: true });
  element.addEventListener('touchmove', (e) => handleSwipeMove(e, type), { passive: false });
  element.addEventListener('touchend', (e) => handleSwipeEnd(e, type), { passive: true });
  element.addEventListener('mousedown', (e) => handleSwipeStart(e, type));
  element.addEventListener('mousemove', (e) => handleSwipeMove(e, type));
  element.addEventListener('mouseup', (e) => handleSwipeEnd(e, type));
  element.addEventListener('mouseleave', (e) => handleSwipeEnd(e, type));
}

function handleSwipeStart(e, type) {
  if (e.target.closest('.expense-item') || e.target.closest('.swipe-actions')) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
  const touch = e.touches ? e.touches[0] : e;
  swipeState.startX = touch.clientX;
  swipeState.startY = touch.clientY;
  swipeState.isDragging = true;
  swipeState.element = e.currentTarget;
  swipeState.type = type;
}

function handleSwipeMove(e, type) {
  if (!swipeState.isDragging) return;
  const touch = e.touches ? e.touches[0] : e;
  swipeState.currentX = touch.clientX;
  swipeState.currentY = touch.clientY;
  const deltaX = swipeState.currentX - swipeState.startX;
  const deltaY = swipeState.currentY - swipeState.startY;
  if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
    e.preventDefault();
    const moveAmount = Math.min(Math.abs(deltaX) / 4, 40);
    const direction = deltaX > 0 ? moveAmount : -moveAmount;
    swipeState.element.style.transform = `translateX(${direction}px)`;
    const opacity = 1 - (Math.abs(deltaX) / 400);
    swipeState.element.style.opacity = Math.max(opacity, 0.8);
  }
}

function handleSwipeEnd(e, type) {
  if (!swipeState.isDragging) return;
  const deltaX = swipeState.currentX - swipeState.startX;
  const deltaY = swipeState.currentY - swipeState.startY;
  if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeState.threshold) {
    if (deltaX > 0) {
      if (type === 'period') changePeriod(-1);
      else if (type === 'month') changeMonth(-1);
      showSwipeFeedback(swipeState.element, 'left');
    } else {
      if (type === 'period') changePeriod(1);
      else if (type === 'month') changeMonth(1);
      showSwipeFeedback(swipeState.element, 'right');
    }
    if (navigator.vibrate) navigator.vibrate([30, 20, 30]);
  } else {
    swipeState.element.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
    swipeState.element.style.transform = 'translateX(0)';
    swipeState.element.style.opacity = '1';
    setTimeout(() => { swipeState.element.style.transition = ''; }, 300);
  }
  swipeState.isDragging = false;
  swipeState.startX = 0;
  swipeState.startY = 0;
  swipeState.currentX = 0;
  swipeState.currentY = 0;
}

function showSwipeFeedback(element, direction) {
  const indicator = document.createElement('div');
  indicator.className = 'swipe-indicator';
  indicator.innerHTML = direction === 'left' ? '‚Äπ‚Äπ‚Äπ' : '‚Ä∫‚Ä∫‚Ä∫';
  indicator.style.cssText = `position:absolute; top:50%; ${direction === 'left' ? 'left:30px' : 'right:30px'}; transform:translateY(-50%); font-size:4rem; color:rgba(251,191,36,0.9); font-weight:900; z-index:100; pointer-events:none; text-shadow:0 0 20px rgba(251,191,36,0.5); animation:swipeIndicator 0.6s ease-out`;
  element.style.position = 'relative';
  element.appendChild(indicator);
  element.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s ease';
  if (direction === 'left') element.style.transform = 'translateX(120px) scale(0.97)';
  else element.style.transform = 'translateX(-120px) scale(0.97)';
  element.style.opacity = '0.5';
  setTimeout(() => {
    element.style.transform = 'translateX(0) scale(1)';
    element.style.opacity = '1';
  }, 180);
  setTimeout(() => {
    if (indicator.parentNode) indicator.remove();
    element.style.transition = '';
  }, 700);
}

// Initialize everything on load
window.addEventListener('DOMContentLoaded', () => {
  initAuth();
  initSwipeGestures();
});


// Utility Disclaimer Functions
function showUtilityDisclaimer() {
  const dismissed = localStorage.getItem('utilityDisclaimerDismissed');
  const disclaimer = document.getElementById('utility-disclaimer');
  if (disclaimer && dismissed !== 'true') {
    disclaimer.style.display = 'block';
  }
}

function dismissUtilityDisclaimer(permanent) {
  const disclaimer = document.getElementById('utility-disclaimer');
  if (disclaimer) {
    disclaimer.style.display = 'none';
  }
  if (permanent) {
    localStorage.setItem('utilityDisclaimerDismissed', 'true');
  }
}

// Push Notification Functions
let notificationPermission = 'default';

async function initNotifications() {
  if (!('Notification' in window)) {
    console.log('Notifications not supported');
    return;
  }

  const enabled = localStorage.getItem('notificationsEnabled') === 'true';
  const toggle = document.getElementById('notifications-toggle');
  if (toggle) {
    toggle.checked = enabled;
  }

  notificationPermission = Notification.permission;
  updateNotificationStatus();
}

async function toggleNotifications() {
  const toggle = document.getElementById('notifications-toggle');
  const enabled = toggle.checked;

  if (enabled) {
    if (Notification.permission === 'default') {
      const permission = await Notification.requestPermission();
      notificationPermission = permission;

      if (permission === 'granted') {
        localStorage.setItem('notificationsEnabled', 'true');
        showNotificationStatus('‚úÖ Notifications enabled!', 'success');

        setTimeout(() => {
          showTestNotification();
        }, 500);

        schedulePayPeriodNotifications();
      } else {
        toggle.checked = false;
        showNotificationStatus('‚ùå Permission denied. Enable in browser settings.', 'error');
      }
    } else if (Notification.permission === 'granted') {
      localStorage.setItem('notificationsEnabled', 'true');
      showNotificationStatus('‚úÖ Notifications enabled!', 'success');
      schedulePayPeriodNotifications();
    } else {
      toggle.checked = false;
      showNotificationStatus('‚ùå Permission denied. Enable in browser settings.', 'error');
    }
  } else {
    localStorage.setItem('notificationsEnabled', 'false');
    showNotificationStatus('üîï Notifications disabled', 'info');
    cancelScheduledNotifications();
  }

  updateNotificationStatus();
}

function showTestNotification() {
  if (Notification.permission === 'granted') {
    const notification = new Notification('üí∞ Expense Tracker', {
      body: 'Notifications are now enabled! You\'ll get reminders at the start of each pay period.',
      icon: 'üí∞',
      badge: 'üí∞',
      tag: 'test-notification',
      requireInteraction: false
    });

    notification.onclick = function() {
      window.focus();
      notification.close();
    };
  }
}

function schedulePayPeriodNotifications() {
  const checkInterval = 1000 * 60 * 60 * 24;

  const intervalId = setInterval(() => {
    checkAndSendNotification();
  }, checkInterval);

  localStorage.setItem('notificationIntervalId', intervalId);
  checkAndSendNotification();
}

function cancelScheduledNotifications() {
  const intervalId = localStorage.getItem('notificationIntervalId');
  if (intervalId) {
    clearInterval(parseInt(intervalId));
    localStorage.removeItem('notificationIntervalId');
  }
}

function checkAndSendNotification() {
  if (localStorage.getItem('notificationsEnabled') !== 'true') return;
  if (Notification.permission !== 'granted') return;

  const period = calculateCurrentPeriod(0);
  if (!period) return;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const periodStart = new Date(period.start);
  periodStart.setHours(0, 0, 0, 0);

  if (today.getTime() === periodStart.getTime()) {
    const lastNotification = localStorage.getItem('lastNotificationDate');
    const todayStr = today.toISOString().split('T')[0];

    if (lastNotification !== todayStr) {
      sendPayPeriodNotification(period);
      localStorage.setItem('lastNotificationDate', todayStr);
    }
  }
}

function sendPayPeriodNotification(period) {
  const salary = salaries[period.key] || 0;
  const formattedDates = formatPeriodDates(period.start, period.end);

  const notification = new Notification('üí∞ New Pay Period Started!', {
    body: `${formattedDates}\nSalary: $${salary.toFixed(2)}\nTime to track your expenses!`,
    icon: 'üí∞',
    badge: 'üí∞',
    tag: 'pay-period-' + period.key,
    requireInteraction: false,
    vibrate: [200, 100, 200]
  });

  notification.onclick = function() {
    window.focus();
    notification.close();
  };
}

function formatPeriodDates(start, end) {
  const options = { month: 'short', day: 'numeric' };
  return start.toLocaleDateString('en-US', options) + ' - ' + end.toLocaleDateString('en-US', options);
}

function updateNotificationStatus() {
  const statusDiv = document.getElementById('notification-status');
  const statusText = document.getElementById('notification-status-text');

  if (!statusDiv || !statusText) return;

  const enabled = localStorage.getItem('notificationsEnabled') === 'true';

  if (!('Notification' in window)) {
    statusDiv.style.display = 'block';
    statusText.innerHTML = '‚ö†Ô∏è Notifications not supported in this browser';
    statusDiv.style.background = 'rgba(239,68,68,0.1)';
  } else if (enabled && Notification.permission === 'granted') {
    statusDiv.style.display = 'block';
    statusText.innerHTML = '‚úÖ Notifications active';
    statusDiv.style.background = 'rgba(16,185,129,0.1)';
  } else if (Notification.permission === 'denied') {
    statusDiv.style.display = 'block';
    statusText.innerHTML = '‚ùå Enable notifications in browser settings';
    statusDiv.style.background = 'rgba(239,68,68,0.1)';
  } else {
    statusDiv.style.display = 'none';
  }
}

function showNotificationStatus(message, type) {
  const statusDiv = document.getElementById('notification-status');
  const statusText = document.getElementById('notification-status-text');

  if (!statusDiv || !statusText) return;

  statusText.textContent = message;
  statusDiv.style.display = 'block';

  const colors = {
    success: 'rgba(16,185,129,0.1)',
    error: 'rgba(239,68,68,0.1)',
    info: 'rgba(59,130,246,0.1)'
  };

  statusDiv.style.background = colors[type] || colors.info;

  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 5000);
}

// Initialize everything on load
document.addEventListener('DOMContentLoaded', function() {
  showUtilityDisclaimer();
  initNotifications();
});

</script>

<!-- ==================== AUTHENTICATION SYSTEM ==================== -->

<!-- Passcode Setup -->
<div id="passcode-setup-modal" class="modal auth-modal">
  <div class="modal-content auth-content">
    <div class="modal-header"><div class="modal-title">üîê Secure Your App</div></div>
    <div class="auth-icon">üîí</div>
    <p class="auth-subtitle">Create a 6-digit passcode to protect your financial data</p>
    <div class="passcode-input-group">
      <input type="password" id="setup-1" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="setup-2" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="setup-3" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="setup-4" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="setup-5" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="setup-6" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
    </div>
    <p class="passcode-hint">Enter 6 digits (0-9)</p>
    <div class="modal-buttons">
      <button class="modal-btn save" onclick="completeAuthSetup()">üîí Complete Setup</button>
    </div>
  </div>
</div>

  <div id="recovery-code-modal" class="modal auth-modal" style="z-index:10001"><div class="modal-content" style="max-width:550px"><div class="modal-header"><div class="modal-title">‚úÖ PIN Created!</div></div><div class="auth-content"><div class="auth-icon">üîë</div><p class="auth-subtitle" style="font-size:1.1rem;margin-bottom:20px"><strong>Your Recovery Code:</strong></p><div style="background:rgba(251,191,36,0.15);border:2px solid rgba(251,191,36,0.4);border-radius:16px;padding:30px;margin:20px 0"><div id="recovery-display-code" style="font-size:3rem;font-weight:800;letter-spacing:8px;color:#fbbf24;text-align:center;font-family:monospace">XXXX</div></div><div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:20px;margin:20px 0"><p style="color:rgba(255,255,255,0.9);font-size:0.95rem;margin:0"><strong style="color:#ef4444">‚ö†Ô∏è</strong> Email NOW!</p></div><button class="modal-btn save" style="width:100%;margin-bottom:12px" onclick="emailRecoveryCode()">üìß Email</button><button class="modal-btn cancel" style="width:100%" onclick="closeRecoveryCodeModal()">Later</button></div></div></div>
  <div id="recovery-input-modal" class="modal auth-modal" style="z-index:10001"><div class="modal-content"><div class="modal-header"><div class="modal-title">üîì Enter Code</div><button class="close-btn" onclick="closeRecoveryInputModal()">√ó</button></div><div class="auth-content"><div class="auth-icon">üîë</div><p class="auth-subtitle">4-character code from email</p><div class="passcode-input-group"><input type="text" class="passcode-digit" id="recovery-1" maxlength="1" style="text-transform:uppercase"><input type="text" class="passcode-digit" id="recovery-2" maxlength="1" style="text-transform:uppercase"><input type="text" class="passcode-digit" id="recovery-3" maxlength="1" style="text-transform:uppercase"><input type="text" class="passcode-digit" id="recovery-4" maxlength="1" style="text-transform:uppercase"></div><p class="passcode-hint">From email</p><button class="modal-btn save" style="width:100%;margin-top:20px" onclick="verifyRecoveryCode()">‚úÖ Verify</button></div></div></div>
  <div id="new-pin-modal" class="modal auth-modal" style="z-index:10001"><div class="modal-content"><div class="modal-header"><div class="modal-title">üîë New PIN</div></div><div class="auth-content"><div class="auth-icon">‚úÖ</div><p class="auth-subtitle">Create new PIN</p><div class="passcode-input-group"><input type="password" class="passcode-digit" id="newpin-1" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="newpin-2" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="newpin-3" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="newpin-4" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="newpin-5" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="newpin-6" maxlength="1" inputmode="numeric"></div><p class="passcode-hint">6 digits</p><button class="modal-btn save" style="width:100%;margin-top:20px" onclick="saveNewPinAfterRecovery()">‚úÖ Save</button></div></div></div>
  <div id="regenerate-recovery-modal" class="modal auth-modal" style="z-index:10001"><div class="modal-content"><div class="modal-header"><div class="modal-title">üîê Verify PIN</div><button class="close-btn" onclick="closeRegenerateModal()">√ó</button></div><div class="auth-content"><div class="auth-icon">üîë</div><p class="auth-subtitle">Enter current PIN</p><div class="passcode-input-group"><input type="password" class="passcode-digit" id="verify-1" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="verify-2" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="verify-3" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="verify-4" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="verify-5" maxlength="1" inputmode="numeric"><input type="password" class="passcode-digit" id="verify-6" maxlength="1" inputmode="numeric"></div><p class="passcode-hint">Current PIN</p><button class="modal-btn save" style="width:100%;margin-top:20px" onclick="verifyPinAndGenerateNew()">‚úÖ Generate</button></div></div></div>
  <div id="new-recovery-code-modal" class="modal auth-modal" style="z-index:10002"><div class="modal-content" style="max-width:550px"><div class="modal-header"><div class="modal-title">‚úÖ New Code!</div></div><div class="auth-content"><div class="auth-icon">üîë</div><p class="auth-subtitle" style="font-size:1.1rem;margin-bottom:20px"><strong>NEW Code:</strong></p><div style="background:rgba(251,191,36,0.15);border:2px solid rgba(251,191,36,0.4);border-radius:16px;padding:30px;margin:20px 0"><div id="new-recovery-display" style="font-size:3rem;font-weight:800;letter-spacing:8px;color:#fbbf24;text-align:center;font-family:monospace">XXXX</div></div><div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:20px;margin:20px 0"><p style="color:rgba(255,255,255,0.9);font-size:0.95rem;margin:0"><strong style="color:#3b82f6">‚ÑπÔ∏è</strong> Old code invalid!</p></div><button class="modal-btn save" style="width:100%;margin-bottom:12px" onclick="emailRecoveryCode()">üìß Email</button><button class="modal-btn cancel" style="width:100%" onclick="closeNewRecoveryModal()">Done</button></div></div></div>
  <!-- Lock Screen -->
<div id="lock-screen" style="display:none">
  <div class="lock-container">
    <div class="lock-header">
      <div style="font-size:4rem">üí∞</div>
      <h1 style="font-size:1.8rem; margin:10px 0">Expense Tracker</h1>
      <p style="color:rgba(255,255,255,0.6); margin-bottom:40px">Enter your passcode</p>
    </div>
    <div class="passcode-input-group">
      <input type="password" id="unlock-1" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="unlock-2" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="unlock-3" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="unlock-4" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="unlock-5" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
      <input type="password" id="unlock-6" maxlength="1" class="passcode-digit" inputmode="numeric" pattern="[0-9]">
    </div>
    <div id="passcode-error" style="display:none; color:#ef4444; margin-top:20px; font-weight:600">‚ùå Incorrect passcode</div>
        <div style="margin-top:30px"><button style="background:rgba(59,130,246,0.2);border:1px solid rgba(59,130,246,0.4);color:#3b82f6;padding:14px;border-radius:12px;cursor:pointer;font-weight:700;font-size:1rem;width:100%" onclick="showRecoveryCodeInput()">üîë Use Recovery Code</button></div><div style="margin-top:12px"><button style="background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:10px;border-radius:10px;cursor:pointer;font-size:0.85rem;width:100%" onclick="resetAppFromLockScreen()">üóëÔ∏è Reset</button></div>

    <div style="margin-top:30px">
      
    </div>
  </div>
</div>

<!-- Recovery Key Input -->
<div id="recovery-key-input-modal" class="modal auth-modal">
  <div class="modal-content auth-content">
    <div class="modal-header">
      <div class="modal-title">üîë Enter Recovery Key</div>
      <button class="close-btn" onclick="closeRecoveryKeyInput()">‚úï</button>
    </div>
    <p class="auth-subtitle">Enter your 12-word recovery key (separated by spaces or dashes)</p>
    <div class="input-group">
      <textarea id="recovery-key-input" placeholder="word1-word2-word3-word4-word5-word6-word7-word8-word9-word10-word11-word12" rows="4" style="width:100%; resize:vertical"></textarea>
    </div>
    <div id="recovery-key-error" style="display:none; color:#ef4444; margin-top:10px; font-weight:600">‚ùå Invalid recovery key</div>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeRecoveryKeyInput()">Cancel</button>
      <button class="modal-btn save" onclick="verifyRecoveryKey()">Unlock App</button>
    </div>
  </div>
</div>


<!-- Critical Fix: Make saveData() always sync to Firebase -->
<script>
// Override saveData to ALWAYS trigger Firebase sync
(function() {
  // Wait for page to load, then wrap saveData
  window.addEventListener('DOMContentLoaded', function() {
    const originalSaveData = window.saveData;

    window.saveData = function() {
      console.log('üíæ saveData called');

      // Call original saveData (localStorage + UI updates)
      if (originalSaveData) {
        originalSaveData();
      } else {
        // Fallback: save manually
        try {
          localStorage.setItem('transactions', JSON.stringify(window.transactions || []));
          localStorage.setItem('salaries', JSON.stringify(window.salaries || {}));
          localStorage.setItem('utilities', JSON.stringify(window.utilities || []));
          localStorage.setItem('paySettings', JSON.stringify(window.settings || null));
          console.log('‚úÖ Saved to localStorage');
        } catch(e) {
          console.error('localStorage error:', e);
        }
      }

      // ALWAYS sync to Firebase if logged in
      if (window.saveToFirebase && window.currentUser) {
        console.log('üîÑ Triggering Firebase sync...');
        window.saveToFirebase();
      } else if (!window.currentUser) {
        console.log('‚ö†Ô∏è Not logged in to Firebase - local only');
      }
    };

    console.log('‚úÖ saveData wrapper installed');
  });
})();

// Fix saveSettings to properly call saveData
window.saveSettings = function() {
  console.log('üíæ saveSettings called');

  const newStartDate = document.getElementById('settings-start-date').value;

  if (!newStartDate) {
    alert('Enter a valid start date');
    return;
  }

  if (!confirm('Change pay cycle start date? This recalculates all periods.')) {
    return;
  }

  // Update settings
  window.settings.startDate = newStartDate;
  window.settings.lastModified = new Date().toISOString();

  console.log('‚úÖ Settings updated:', window.settings);

  // Save locally AND to Firebase
  window.saveData();

  // Update displays
  currentPeriodOffset = 0;
  updatePeriodDisplay();

  // Close modal
  closeSettings();

  alert('‚úÖ Pay cycle updated!');
};
</script>
</body></html>
